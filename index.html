<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forever Living by Muhd Arvind Isa</title>
  
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-festival="">

<div id="maintenance-overlay">
  <div><i class="fa-solid fa-person-digging"></i><h1>Under Maintenance</h1><p id="maintenance-message">We'll be back shortly!</p></div>
</div>
<div class="festive-layer"></div>
<div id="store-wrapper">
  <header>
    <div class="container"><div class="header-content"><img src="FL.jpg" alt="Business Logo" class="header-logo" onerror="this.style.display='none'"><h1>FOREVER LIVING by Muhd Arvind Isa<span style="font-size: 1rem; color: #555; display: block; font-weight: 400;">Quality Wellness Products</span></h1></div></div>
  </header>
  <div id="promo-running-banner"><div class="marquee-content" id="promo-banner-text"></div></div>
  <nav>
    <div class="container">
        <ul id="main-nav">
          <li><a onclick="showTab('products')">Products</a></li>
          <li><a onclick="showTab('business')">Business Opportunity</a></li>
          <li><a onclick="showTab('about')">About Us</a></li>
          <li><a class="nav-disabled">Rewards</a></li>
          <li><a class="nav-disabled">My Forever Living</a></li>
        </ul>
    </div>
  </nav>
  <main id="main-content" class="container">
    <div id="products" class="tab-content active">
      <section class="hero-section" id="hero-section">
        <h2 id="hero-title"><i class="fa-solid fa-store"></i> Welcome to Our Store</h2>
        <p id="hero-subtitle">Enjoy high-quality wellness products for a healthier lifestyle.</p>
        <div id="countdown-timer" style="display:none;"></div>
      </section>
      <div class="search-container">
        <input type="text" id="product-search" onkeyup="filterProducts()" placeholder="Search for products by name..."><i class="fa-solid fa-search search-icon"></i>
      </div>
      <div id="product-list-container"><p style="text-align: center; width: 100%;"><i class="fa-solid fa-spinner fa-spin"></i> Loading products from our catalog...</p></div>
    </div>
    <div id="business" class="tab-content">
      <section class="program-section">
        <h2>Build Your Forever Business</h2>
        <p style="text-align: center; max-width: 800px; margin: 20px auto;">The Forever Living opportunity is more than just selling high-quality products; it's a chance to build a flexible, rewarding business on your own terms. Whether you're looking for extra income or a full-time career, Forever provides a proven path to success.</p>
        <h3 style="margin-top:40px;">How Does It Work?</h3>
        <ul><li><strong>Become Your Own Boss:</strong> As a Forever Business Owner (FBO), you have the freedom to work from anywhere, set your own hours, and grow at your own pace. There are no large startup fees or required inventory purchases.</li><li><strong>A Simple, Proven Model:</strong> The business is built on a simple cycle: Use the products yourself, share your experience and the products with others, and build a team of like-minded individuals to do the same.</li><li><strong>Earn Generous Rewards:</strong> You earn income from your retail sales and from the sales of your team members. Forever offers one of the most generous compensation plans in the industry, including performance bonuses, the car plan (Earn While you Drive), and global travel incentives.</li><li><strong>World-Class Support:</strong> You are never alone. You will receive mentorship, training materials, and support from our team at Rich Academy Global and the wider Forever community to help you achieve your goals.</li></ul>
        <h3 style="margin-top:40px;">Ready to Start Your Journey?</h3>
        <p style="text-align: center;">Take the first step towards a healthier, wealthier life. Contact us today to learn more without any obligation.</p>
        <a href="https://wa.me/601111033154?text=Hi,%20I'm%20interested%20in%20learning%20more%20about%20the%20Forever%20Living%20business%20opportunity." class="cta-button" target="_blank"><i class="fab fa-whatsapp"></i> Click to Learn More on WhatsApp</a>
      </section>
    </div>
    <div id="about" class="tab-content">
      <section class="about-us-section">
        <h2>About Us</h2>
        <div class="owner-profile">
            <img src="owner.jpg" alt="Muhd Arvind Isa" class="owner-image" onerror="this.src='https://via.placeholder.com/150'">
            <div class="owner-details">
                <h3>Muhd Arvind Isa - Independent FBO</h3>
                <p>Welcome! I am an authorized Independent Forever Business Owner (FBO) dedicated to bringing you the highest quality health and wellness products from Forever Living. My mission is to empower individuals to lead healthier lives and to provide opportunities for financial well-being through the Forever business model.</p>
                <p><strong>Powered by:</strong> Rich Academy Global</p>
                <p><strong>Contact Information:</strong></p>
                <ul><li><strong><i class="fab fa-whatsapp"></i> WhatsApp:</strong> <a href="https://wa.me/601111033154">+6011 1103 3154</a></li><li><strong><i class="fa fa-envelope"></i> Email:</strong> <a href="mailto:cs.foreverlivingbymuhdarvindisa@gmail.com">cs.foreverlivingbymuhdarvindisa@gmail.com</a></li></ul>
            </div>
        </div>
        <hr style="margin: 30px 0;">
        <h3>The Forever Living Legacy</h3>
        <p>Founded in 1978 by Rex Maughan, Forever Living Products is a multi-billion dollar company that manufactures and sells hundreds of wellness and beauty products all around the world. What makes Forever unique is its commitment to quality through a process called "from seed to product."</p>
        <ul><li><strong>The Aloe Vera Company:</strong> Forever owns its own aloe vera plantations in Texas and the Dominican Republic, ensuring the purest and most potent aloe is used in its products. They control the entire process, from planting and harvesting to processing and manufacturing.</li><li><strong>Global Presence:</strong> For over 40 years, Forever has grown to operate in more than 160 countries, demonstrating the universal appeal and effectiveness of its products and business model.</li><li><strong>Our Commitment:</strong> We are committed to providing authentic Forever Living products, exceptional customer service, and reliable support for both our customers and business partners. All products are sourced directly from Forever Living Products and are guaranteed to be genuine.</li></ul>
        <hr style="margin: 30px 0;">
        <h3>Feedback & Order Requests</h3>
        <form class="feedback-form" onsubmit="sendFeedbackEmail(event)">
            <input type="text" id="feedback-name" placeholder="Your Name" required>
            <input type="email" id="feedback-email" placeholder="Your Email" required>
            <select id="feedback-subject" required>
                <option value="" disabled selected>Select a Subject...</option>
                <option value="General Enquiry">General Enquiry</option>
                <option value="Order Request">Order Request</option>
                <option value="Compliment">Compliment</option>
                <option value="Complaint">Complaint</option>
                <option value="Suggestion">Suggestion</option>
            </select>
            <textarea id="feedback-message" placeholder="Your Message" required></textarea>
            <button type="submit" id="feedback-submit-btn" class="btn btn-primary">Send Message</button>
            <p id="feedback-status"></p>
        </form>
      </section>
    </div>
  </main>
  <footer class="footer">
      <div class="container">
        <p>Â© 2025 Forever Living by Muhd Arvind Isa. All rights reserved.</p>
        <div class="timestamp">Last updated: <span id="update-timestamp"></span></div>
        <section class="disclaimer"><strong>Disclaimer:</strong> This website is operated by an independent FBO and is not the official site of Forever Living Products.</section>
      </div>
  </footer>
</div>
<!-- CART MODAL -->
<div id="cart-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="toggleCart(true)">Ã—</span>
      <div id="cart-view">
        <h2>Your Shopping Cart</h2>
        <div id="cart-items"><p>Your cart is currently empty.</p></div>
        <div class="cart-summary">
          <div class="summary-line"><span>Subtotal</span><span id="cart-subtotal">RM 0.00</span></div>
          <div class="summary-line" id="discount-line" style="display:none;"><span>Discount</span><span id="cart-discount">RM 0.00</span></div>
          <div class="summary-line"><span>Shipping</span><span id="cart-shipping">RM 0.00</span></div>
          <div class="summary-line" id="savings-line" style="display:none; color: var(--accent-color); font-weight: bold;"><span>You Saved</span><span id="cart-savings">RM 0.00</span></div>
          <div class="summary-line total"><span>Total</span><span id="cart-total">RM 0.00</span></div>
          <div id="points-earned-display"></div>
        </div>
        <div class="discount-section">
            <input type="text" id="discount-code-input" placeholder="Enter Discount Code"><button class="btn btn-secondary" onclick="applyDiscount()">Apply</button>
        </div>
        <p id="discount-status"></p>
        <div class="customer-info-form">
          <h3 style="margin-top: 20px;">Customer & Shipping Information</h3>
          <input type="text" id="customer-name" placeholder="Your Full Name" required>
          <input type="tel" id="customer-phone" placeholder="Your WhatsApp Number (e.g., +60123456789)" required>
          <input type="email" id="customer-email" placeholder="Your Email Address (for receipt)" required>
          <input type="text" id="customer-address1" placeholder="Address Line 1" required>
          <input type="text" id="customer-address2" placeholder="Address Line 2 (Optional)">
          <input type="text" id="customer-city" placeholder="City" required>
          <input type="text" id="customer-state" placeholder="State" required>
          <input type="text" id="customer-postcode" placeholder="Postcode" required>
        </div>
        <div id="consent-form">
            <label for="consent-checkbox">
                <input type="checkbox" id="consent-checkbox" onchange="toggleCheckoutButton()">
                <span>I consent to the collection of my personal data for transaction purposes. You can request data deletion at any time via <a href="https://wa.me/601111033154?text=Hi,%20I%20would%20like%20to%20request%20my%20personal%20data%20to%20be%20deleted." target="_blank">WhatsApp</a> or <a href="mailto:cs.foreverlivingbymuhdarvindisa@gmail.com?subject=Request%20for%20Data%20Deletion">Email</a>.</span>
            </label>
        </div>
        <button class="btn btn-primary checkout-btn" id="checkout-btn" onclick="initiateCheckout()" disabled>Proceed to Payment Upload</button>
      </div>
      <div id="verification-view" style="display: none;">
        <h2>Order Verification</h2>
        <div id="proof-upload-step" class="verification-step active">
            <h4><i class="fa-solid fa-arrow-up-from-bracket"></i> Step 1: Upload Payment Proof</h4>
            <p style="font-size: 0.9rem; color: #555;">Upload a screenshot of your transaction receipt.</p>
            <input type="file" id="payment-proof-upload" accept="image/*">
            <button class="btn btn-primary" id="upload-proof-btn" onclick="uploadProof()">Upload and Start Verification</button>
            <p id="upload-status"></p>
        </div>
        <div id="code-verification-step" class="verification-step">
            <h4><i class="fa-solid fa-key"></i> Step 2: Finalize with Code</h4>
            <p id="verification-prompt">Please wait while our admin reviews your payment. Once approved, you will receive a verification code via WhatsApp.</p>
            <input type="text" id="verification-code" placeholder="Enter Verification Code">
            <button class="btn btn-primary" id="finalize-order-btn" onclick="finalizeOrder()">Finalize Order & Get Receipt</button>
            <p id="verification-status"></p>
        </div>
        <button class="btn btn-secondary" style="margin-top: 20px;" onclick="cancelVerification()">Cancel Entire Order</button>
      </div>
    </div>
</div>

<!-- FLOATING ACTION BUTTONS CONTAINER -->
<div class="fab-container" id="fab-container">
    <div id="floating-cart" class="fab floating-cart-btn" onclick="toggleCart()">
        <i class="fa-solid fa-cart-shopping"></i>
        <span id="cart-count">0</span>
    </div>
    <div class="fab chatbot-fab" onclick="toggleChatWidget(true)">
        <i class="fa-solid fa-robot"></i>
    </div>
</div>

<!-- E-SHOP ON-SCREEN AI CHATBOT WIDGET -->
<div id="eshop-chat-widget">
    <div id="chat-header">
        FL AI Assistant
        <button id="close-chat-btn" onclick="toggleChatWidget(false)">&times;</button>
    </div>
    <div id="chat-body">
        <!-- Chat messages will be added here by JavaScript -->
    </div>
    <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="Ask a question...">
        <button id="chat-send-btn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>
<script>
    // =================================================================
    // SECTION A: COMPLETE E-SHOP SCRIPT (VERSION 12 - FINAL)
    // =================================================================
    const googleScriptURL = 'https://script.google.com/macros/s/AKfycbzSEYPLuGuKKoEBUcyTuDGW3AOqtZ57Fdg28yKvhqgAXHmc42sZKcXtCPqfvt7DbtyS/exec';
    const botServerURL = 'https://whatsapp-eshop-bot.onrender.com/eshop-chat';
    
    let products = []; let cart = []; let activeFestival = null; let activePromotions = [];
    let shippingRules = {}; let availableDiscountCodes = {}; let appliedDiscount = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        // Add event listener for the new AI chat input
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        chatSendBtn.addEventListener('click', handleAIChatSubmit);
        chatInput.addEventListener('keyup', (event) => {
            if (event.key === "Enter") {
                handleAIChatSubmit();
            }
        });
    });

    async function fetchData() {
        const productListContainer = document.getElementById("product-list-container");
        try {
            const response = await fetch(googleScriptURL);
            if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
            const data = await response.json();
            if (data.status !== 'success') throw new Error(data.message || 'Failed to parse data.');
            const marketingSettings = data.marketing || {};
            if (marketingSettings.MaintenanceMode === true) {
                document.getElementById('maintenance-message').textContent = marketingSettings.MaintenanceMessage || "We'll be back shortly!";
                document.getElementById('maintenance-overlay').style.display = 'flex';
                return;
            }
            products = data.products || [];
            activeFestival = data.activeFestival || null;
            activePromotions = data.activePromotions || [];
            shippingRules = data.shippingRules || {};
            availableDiscountCodes = data.discountCodes || {};
            initializeUI(marketingSettings);
        } catch (error) {
            console.error("Error fetching store data:", error);
            if (productListContainer) {
                productListContainer.innerHTML = `<p style="text-align: center; color: red; font-weight: bold; width: 100%; padding: 40px 0;"><i class="fa-solid fa-triangle-exclamation"></i> Error loading store.<br>Could not retrieve catalog. Please try again later.</p>`;
            }
        }
        document.getElementById('update-timestamp').textContent = `${new Date().toLocaleDateString('en-GB')} (v12.0)`;
        const pendingOrder = JSON.parse(sessionStorage.getItem("pendingOrder"));
        if (pendingOrder) { 
            toggleCart();
            document.getElementById('cart-view').style.display = 'none';
            document.getElementById('verification-view').style.display = 'block';
            updateVerificationUI();
        } 
        else { showTab('products'); }
    }

    function initializeUI(marketingSettings) {
        const body = document.body;
        body.removeAttribute("data-festival");
        if (activeFestival && activeFestival.theme) {
            const themeMap = { "CNY": "cny", "NationalDay": "national-day", "MalaysiaDay": "malaysia-day", "MooncakeFestival": "mid-autumn", "Thaipusam": "thaipusam", "HariRaya": "hari-raya", "Deepavali": "deepavali", "Christmas": "christmas", "GrandOpening": "grand-opening", "NewYear": "new-year"};
            const festiveAttr = themeMap[activeFestival.theme];
            if(festiveAttr) { body.setAttribute("data-festival", festiveAttr); }
            document.getElementById('hero-title').innerHTML = `<i class="fa-solid fa-gift"></i> ${activeFestival.name}`;
            document.getElementById('hero-subtitle').textContent = "Enjoy special festive offers!";
        } else {
            document.getElementById('hero-title').innerHTML = `<i class="fa-solid fa-store"></i> Welcome to Our Store`;
            document.getElementById('hero-subtitle').textContent = "Enjoy high-quality wellness products for a healthier lifestyle.";
        }
        const banner = document.getElementById('promo-running-banner');
        const bannerTextEl = document.getElementById('promo-banner-text');
        if (marketingSettings.BannerText) {
            bannerTextEl.textContent = `ðŸ”¥ ${marketingSettings.BannerText} ðŸ”¥`;
            banner.style.backgroundColor = 'var(--primary-color)';
            banner.style.color = 'white';
            banner.style.display = 'block';
        } else if (activePromotions.length > 0) {
            const promoNames = activePromotions.map(p => p.description).join(' | ');
            bannerTextEl.textContent = `âœ¨ ONGOING PROMOTIONS: ${promoNames} âœ¨`;
            banner.style.backgroundColor = 'var(--accent-color)';
            banner.style.color = 'white';
            banner.style.display = 'block';
        }
        renderProducts();
    }
    
    function renderProducts(){
        const productListContainer = document.getElementById("product-list-container"); if (!productListContainer) return;
        if (products.length === 0) { productListContainer.innerHTML = `<p style="text-align: center; width: 100%;">No products found in the catalog.</p>`; return; }
        let html = ""; let displayedProductIds = new Set();
        if (activePromotions && activePromotions.length > 0) {
            activePromotions.forEach(promo => {
                const productsInPromo = products.filter(p => promo.productIDs.includes(p.id));
                if (productsInPromo.length > 0) {
                    html += `<section class="promo-section"><h2>${promo.description}</h2><div class="product-list">`;
                    productsInPromo.forEach(product => { 
                        html += renderSingleProduct(product); 
                        displayedProductIds.add(product.id);
                    });
                    html += `</div></section>`;
                }
            });
        }
        const remainingProducts = products.filter(p => !displayedProductIds.has(p.id));
        if (remainingProducts.length > 0) {
            html += `<section class="promo-section"><h2>All Products</h2><div class="product-list">`;
            remainingProducts.forEach(product => { html += renderSingleProduct(product); });
            html += `</div></section>`;
        }
        productListContainer.innerHTML = html;
    }

    function renderSingleProduct(product) {
        let priceHTML = '';
        const priceContainerDiv = document.createElement('div');
        priceContainerDiv.classList.add('price-container');
        if (product.originalPrice && product.originalPrice > product.price) {
            priceHTML = `<span class="original-price">RM ${product.originalPrice.toFixed(2)}</span><span class="new-price promo-price">RM ${product.price.toFixed(2)}</span>`;
        } else {
            priceHTML = `<span class="new-price">RM ${product.price.toFixed(2)}</span>`;
        }
        priceContainerDiv.innerHTML = priceHTML;
        const itemPromo = activePromotions.find(p => p.productIDs.includes(p.id));
        let promoDescriptionHTML = '';
        if (itemPromo && itemPromo.type === 'BUNDLE') {
            promoDescriptionHTML = `<p class="promo-description">${itemPromo.description}</p>`;
        }
        return `
            <div class="product ${itemPromo ? 'promo-highlight' : ''}">
                <div class="halal-badge">HALAL</div>
                ${itemPromo ? '<div class="featured-badge">On Offer!</div>' : ''}
                <div class="product-image-container">
                    <img src="${product.image || 'https://via.placeholder.com/200'}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/200x200?text=Image+Not+Found'">
                </div>
                <div class="product-info">
                    <h3>${product.name}</h3>
                    <div class="price-section">${priceContainerDiv.outerHTML}</div>
                    ${promoDescriptionHTML}
                    <div class="benefits"><strong>Benefits:</strong> ${product.benefits || ''}</div>
                    <div class="consumption"><strong>Usage:</strong> ${product.consumption || ''}</div>
                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="addToCart(${product.id})"><i class="fa-solid fa-cart-plus"></i> Add to Cart</button>
                    </div>
                </div>
            </div>
        `;
    }

    function addToCart(productId) {
        const productToAdd = products.find(p => p.id === productId);
        if (!productToAdd) return;
        const existingItemInCart = cart.find(item => item.id === productId);
        if (existingItemInCart) {
            existingItemInCart.quantity++;
        } else {
            const productMaster = products.find(p => p.id === productId);
            cart.push({
                id: productToAdd.id,
                name: productToAdd.name,
                basePrice: productMaster.originalPrice || productMaster.price,
                price: productToAdd.price, // Captures the promo display price
                quantity: 1
            });
        }
        updateCartDisplay();
    }
    
    function increaseQuantity(productId) { const item = cart.find(i => i.id === productId); if (item) { item.quantity++; } updateCartDisplay(); }
    function decreaseQuantity(productId) { const item = cart.find(i => i.id === productId); if (item) { item.quantity--; if (item.quantity <= 0) { removeItemFromCart(productId); } else { updateCartDisplay(); } } }
    function removeItemFromCart(productId) { cart = cart.filter(item => item.id !== productId); updateCartDisplay(); }
    function updateCartCount() { document.getElementById('cart-count').textContent = cart.reduce((total, item) => total + item.quantity, 0); }

    function applyDiscount() {
        const input = document.getElementById("discount-code-input"); const statusEl = document.getElementById("discount-status"); const code = input.value.trim().toUpperCase();
        if (!code) { statusEl.textContent = "Please enter a code."; statusEl.style.color = "orange"; return; }
        const discountData = availableDiscountCodes[code];
        if (discountData) { appliedDiscount = { code: code, ...discountData }; statusEl.textContent = `Code "${code}" applied successfully!`; statusEl.style.color = "green"; } 
        else { appliedDiscount = null; statusEl.textContent = "Invalid or expired discount code."; statusEl.style.color = "red"; }
        updateCartDisplay();
    }

    function calculateCartTotals() {
        let originalSubtotal = 0;
        let finalSubtotal = 0;
        let tempCart = JSON.parse(JSON.stringify(cart));
        
        tempCart.forEach(item => {
            const productInfo = products.find(p => p.id === item.id);
            item.basePrice = productInfo.originalPrice || productInfo.price;
            originalSubtotal += item.basePrice * item.quantity;
        });

        const allApplicablePromos = activePromotions.filter(promo => tempCart.some(item => promo.productIDs.includes(item.id)));
        const bundlePromos = allApplicablePromos.filter(p => p.type === 'BUNDLE' && p.bundle);
        const itemPromos = allApplicablePromos.filter(p => p.type === 'PERCENT' || p.type === 'FIXED');

        bundlePromos.forEach(promo => {
            const eligibleItems = tempCart.filter(item => promo.productIDs.includes(item.id));
            const totalEligibleQuantity = eligibleItems.reduce((sum, item) => sum + item.quantity, 0);
            const numberOfBundles = Math.floor(totalEligibleQuantity / promo.bundle.quantity);

            if (numberOfBundles > 0) {
                finalSubtotal += numberOfBundles * promo.bundle.price;
                let itemsToDiscount = numberOfBundles * promo.bundle.quantity;
                eligibleItems.sort((a, b) => a.basePrice - b.basePrice);
                for (const item of eligibleItems) {
                    const discountable = Math.min(item.quantity, itemsToDiscount);
                    item.quantity -= discountable;
                    itemsToDiscount -= discountable;
                }
            }
        });

        tempCart.forEach(item => {
            if (item.quantity > 0) {
                const itemPromo = itemPromos.find(p => p.productIDs.includes(item.id));
                let unitPrice = item.basePrice;
                if (itemPromo) {
                    if (itemPromo.type === 'FIXED') { unitPrice = itemPromo.value; } 
                    else if (itemPromo.type === 'PERCENT') { unitPrice = unitPrice * (1 - parseFloat(itemPromo.value) / 100); }
                }
                finalSubtotal += item.quantity * unitPrice;
            }
        });

        let totalDiscount = originalSubtotal - finalSubtotal;
        if (appliedDiscount) {
            let discountFromCode = 0;
            if (appliedDiscount.type.toLowerCase() === 'fixed') { discountFromCode = Math.min(finalSubtotal, parseFloat(appliedDiscount.value)); }
            else if (appliedDiscount.type.toLowerCase() === 'percentage') { discountFromCode = finalSubtotal * (parseFloat(appliedDiscount.value) / 100); }
            finalSubtotal -= discountFromCode;
            totalDiscount += discountFromCode;
        }
        
        const shipping = calculateShipping(cart, finalSubtotal);
        const finalTotal = finalSubtotal + shipping.fee;
        const totalPoints = Math.floor(finalSubtotal);
        const appliedPromoDescriptions = allApplicablePromos.map(p => p.description);
        return { originalSubtotal, totalDiscount, finalSubtotal, shipping, finalTotal, totalPoints, appliedPromoDescriptions: [...new Set(appliedPromoDescriptions)] };
    }
    
    function updateCartDisplay() {
        const cartItemsEl = document.getElementById("cart-items");
        const subtotalEl = document.getElementById("cart-subtotal");
        const discountLineEl = document.getElementById("discount-line");
        const discountEl = document.getElementById("cart-discount");
        const shippingEl = document.getElementById("cart-shipping");
        const totalEl = document.getElementById("cart-total");
        const pointsEl = document.getElementById("points-earned-display");
        const savingsLineEl = document.getElementById("savings-line");
        const savingsEl = document.getElementById("cart-savings");
        updateCartCount();
        const oldPromoList = document.getElementById('applied-promos-list-container');
        if (oldPromoList) oldPromoList.remove();
        if (cart.length === 0) {
            cartItemsEl.innerHTML = "<p>Your cart is currently empty.</p>";
            subtotalEl.textContent = "RM 0.00"; shippingEl.textContent = "RM 0.00"; totalEl.textContent = "RM 0.00";
            pointsEl.innerHTML = ""; discountLineEl.style.display = "none"; savingsLineEl.style.display = "none";
            return;
        }
        const { originalSubtotal, totalDiscount, finalTotal, shipping, totalPoints, appliedPromoDescriptions } = calculateCartTotals();
        let itemsHtml = "";
        cart.forEach(item => {
            itemsHtml += `<div class="cart-item"><div class="cart-item-details"><strong>${item.name}</strong><div class="quantity-controls"><button class="quantity-btn" onclick="decreaseQuantity(${item.id})">-</button><span class="quantity-display">${item.quantity}</span><button class="quantity-btn" onclick="increaseQuantity(${item.id})">+</button></div></div><div style="text-align:right"><div class="final-cart-price">RM ${item.basePrice.toFixed(2)}</div></div><button class="remove-item-btn" onclick="removeItemFromCart(${item.id})"><i class="fa-solid fa-trash-can"></i></button></div>`;
        });
        cartItemsEl.innerHTML = itemsHtml;
        subtotalEl.textContent = `RM ${originalSubtotal.toFixed(2)}`;
        if (totalDiscount > 0.01) {
            discountEl.textContent = `- RM ${totalDiscount.toFixed(2)}`;
            discountLineEl.style.display = "flex";
            savingsEl.textContent = `RM ${totalDiscount.toFixed(2)}`;
            savingsLineEl.style.display = "flex";
        } else {
            discountLineEl.style.display = "none";
            savingsLineEl.style.display = "none";
        }
        if (appliedPromoDescriptions.length > 0) {
            let promoListHTML = appliedPromoDescriptions.map(desc => `<li><small>${desc}</small></li>`).join('');
            const promoListContainerHTML = `<div class="summary-line" id="applied-promos-list-container" style="font-size: 0.9em; color: #555;"><span>Applied Promotions:</span><ul style="padding-left: 15px; margin: 0; text-align: right; list-style-type: none;">${promoListHTML}</ul></div>`;
            shippingEl.parentElement.insertAdjacentHTML('beforebegin', promoListContainerHTML);
        }
        shippingEl.innerHTML = shipping.message === "FREE" ? `<span style="color:var(--accent-color);font-weight:700"><i class="fa-solid fa-truck-fast"></i> FREE! <small>(${shipping.reason || ''})</small></span>` : `RM ${shipping.fee.toFixed(2)}`;
        totalEl.textContent = `RM ${finalTotal.toFixed(2)}`;
        pointsEl.innerHTML = `<div class="points-earned"><i class="fa-solid fa-star"></i> Points to be Earned: ${totalPoints}</div>`;
    }

    function calculateShipping(currentCart, totalAfterDiscounts, promoShippingRuleId) {
        if (currentCart.length === 0) return { fee: 0, message: "RM 0.00" };
        let applicableRule = null;
        if (promoShippingRuleId && shippingRules[promoShippingRuleId]) {
            const promoRule = shippingRules[promoShippingRuleId];
            if (totalAfterDiscounts >= promoRule.minSpend) { applicableRule = { ...promoRule, reason: "Promotion Applied" }; }
        }
        if (!applicableRule && appliedDiscount && appliedDiscount.type === 'FreeShipping') { applicableRule = { type: 'Free', charge: 0, reason: "Discount Code" }; }
        if (!applicableRule) {
            const defaultRules = Object.values(shippingRules).filter(rule => rule.isDefault);
            for (const rule of defaultRules) {
                if (totalAfterDiscounts >= rule.minSpend && totalAfterDiscounts <= rule.maxSpend) {
                    applicableRule = { ...rule, reason: `Order total is RM ${totalAfterDiscounts.toFixed(2)}`};
                    break;
                }
            }
        }
        if (!applicableRule) return { fee: 14, message: "RM 14.00 (Default)" };
        const charge = parseFloat(applicableRule.charge) || 0;
        let message = `RM ${charge.toFixed(2)}`;
        if (charge === 0) message = "FREE";
        return { fee: charge, message: message, reason: applicableRule.reason };
    }

    function initiateCheckout() {
        if (!document.getElementById('consent-checkbox').checked) { alert("You must agree to the data collection consent before proceeding."); return; }
        const customerName = document.getElementById('customer-name').value.trim();
        const customerPhone = document.getElementById('customer-phone').value.trim();
        const customerEmail = document.getElementById('customer-email').value.trim();
        const address1 = document.getElementById('customer-address1').value.trim();
        const address2 = document.getElementById('customer-address2').value.trim();
        const city = document.getElementById('customer-city').value.trim();
        const state = document.getElementById('customer-state').value.trim();
        const postcode = document.getElementById('customer-postcode').value.trim();
        if (!customerName || !customerPhone || !customerEmail || !address1 || !city || !state || !postcode) { alert("Please fill in all required customer and shipping information fields."); return; }
        if (!customerPhone.startsWith('+')) { alert("Invalid phone number. Please include the country code (e.g., +60 or +65)."); return; }
        if (cart.length === 0) { alert("Your cart is empty."); return; }
        
        document.getElementById('checkout-btn').textContent = 'Proceeding to Payment Upload...';
        document.getElementById('checkout-btn').disabled = true;

        document.getElementById('cart-view').style.display = 'none';
        document.getElementById('verification-view').style.display = 'block';
    }
    
    async function uploadProof() {
        const fileInput = document.getElementById('payment-proof-upload');
        const statusEl = document.getElementById('upload-status');
        const uploadBtn = document.getElementById('upload-proof-btn');
        const file = fileInput.files[0];

        if (!file) { statusEl.textContent = "Please select a file to upload."; statusEl.style.color = "red"; return; }
        
        uploadBtn.disabled = true;
        statusEl.textContent = "Uploading...";
        statusEl.style.color = "blue";
        
        const customerName = document.getElementById('customer-name').value.trim();
        const customerPhone = document.getElementById('customer-phone').value.trim();
        const customerEmail = document.getElementById('customer-email').value.trim();
        const address1 = document.getElementById('customer-address1').value.trim();
        const address2 = document.getElementById('customer-address2').value.trim();
        const city = document.getElementById('customer-city').value.trim();
        const state = document.getElementById('customer-state').value.trim();
        const postcode = document.getElementById('customer-postcode').value.trim();
        const totals = calculateCartTotals();
        const fullAddress = `${address1}, ${address2 ? address2 + ", " : ""}${postcode} ${city}, ${state}.`;

        try {
            const base64File = await getBase64(file);
            const payload = {
                action: "logInitialOrderWithProof",
                customerName, customerPhone, customerEmail, customerAddress: fullAddress,
                cart: cart,
                itemsPurchased: cart.map(item => `${item.name} (x${item.quantity})`).join('; '),
                totalAmount: totals.finalTotal.toFixed(2),
                shippingFee: totals.shipping.fee.toFixed(2),
                discountApplied: `Total Discount - RM ${totals.totalDiscount.toFixed(2)}`,
                discountCodeUsed: appliedDiscount ? appliedDiscount.code : "N/A",
                totalPointsForThisPurchase: totals.totalPoints,
                appliedPromotions: totals.appliedPromoDescriptions || [],
                paymentProofFile: base64File.split(",")[1], 
                paymentProofMimeType: file.type,
                paymentProofFileName: `${customerEmail.split("@")[0]}-${Date.now()}`
            };

            const response = await fetch(googleScriptURL, { method: "POST", body: JSON.stringify(payload) });
            const result = await response.json();

            if (result.status === 'success') {
                sessionStorage.setItem("pendingOrder", JSON.stringify({ ...payload, invoiceId: result.invoiceId }));
                onProofUploaded(result.invoiceId, customerName, totals.finalTotal.toFixed(2), result.proofUrl, customerPhone);
            } else { throw new Error(result.message || 'Unknown server error'); }
        } catch (error) {
            statusEl.textContent = `Upload Error: ${error.message}`;
            statusEl.style.color = "red";
            uploadBtn.disabled = false;
        }
    }

    async function finalizeOrder(){
        const codeInput = document.getElementById("verification-code").value.trim().toUpperCase();
        const finalizeBtn = document.getElementById("finalize-order-btn");
        const statusEl = document.getElementById("verification-status");
        let pendingOrder = JSON.parse(sessionStorage.getItem("pendingOrder"));
        if (!codeInput) { statusEl.textContent = "Please enter the verification code."; statusEl.style.color = "red"; return; }
        if (!pendingOrder) { statusEl.textContent = "Error: No pending order found."; statusEl.style.color = "red"; return; }
        finalizeBtn.disabled = true;
        statusEl.textContent = "Verifying...";
        statusEl.style.color = "blue";
        try {
            const payload = { action: "finalizeOrder", usedCode: codeInput, ...pendingOrder };
            const response = await fetch(googleScriptURL, { method: "POST", body: JSON.stringify(payload) });
            const result = await response.json();
            if (result.status !== 'success') { throw new Error(result.message); }
            handleSuccessfulFinalization(result.receiptUrl);
        } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.style.color = "red";
            finalizeBtn.disabled = false;
        }
    }

    function handleSuccessfulFinalization(receiptUrl) {
        const statusEl = document.getElementById("verification-status");
        document.getElementById('verification-prompt').innerHTML = `<h4 style="color:var(--accent-color);">Payment Verified!</h4>`;
        statusEl.innerHTML = `<a href="${receiptUrl}" class="btn btn-primary" style="text-decoration:none;" target="_blank">Click Here to Download Receipt</a>`;
        statusEl.style.color = "green";
        cart = []; sessionStorage.removeItem("pendingOrder"); updateCartDisplay(); appliedDiscount = null;
        document.getElementById("discount-code-input").value = "";
        document.getElementById("discount-status").textContent = "";
    }
    
    function updateVerificationUI(reset = false) {
        const proofStep = document.getElementById('proof-upload-step'), codeStep = document.getElementById('code-verification-step');
        if (reset) {
            proofStep.classList.add('active'); proofStep.classList.remove('completed');
            codeStep.classList.remove('active');
            document.getElementById('payment-proof-upload').value = "";
            document.getElementById('verification-code').value = "";
            return;
        }
        const pendingOrder = JSON.parse(sessionStorage.getItem("pendingOrder"));
        if (pendingOrder && pendingOrder.invoiceId) {
            proofStep.classList.remove('active');
            proofStep.classList.add('completed');
            codeStep.classList.add('active');
        }
    }
    
    function cancelVerification(){
        if(confirm("Are you sure? This will cancel the pending order and clear your cart.")){
            cart = [];
            sessionStorage.removeItem("pendingOrder");
            appliedDiscount = null;
            document.getElementById("discount-code-input").value = "";
            document.getElementById("discount-status").textContent = "";
            updateCartDisplay();
            toggleCart(true);
            document.getElementById('cart-view').style.display = 'block';
            document.getElementById('verification-view').style.display = 'none';
            window.location.reload();
        }
    }
    function toggleCart(t=!1){const e=document.getElementById("cart-modal");if(t)return void(e.style.display="none");"flex"===e.style.display?e.style.display="none":(e.style.display="flex",JSON.parse(sessionStorage.getItem("pendingOrder"))?(document.getElementById("cart-view").style.display="none",document.getElementById("verification-view").style.display="block",updateVerificationUI()):(document.getElementById("cart-view").style.display="block",document.getElementById("verification-view").style.display="none",updateCartDisplay(),updateVerificationUI(!0)))}
    function getBase64(t){return new Promise((e,o)=>{const n=new FileReader;n.readAsDataURL(t),n.onload=()=>e(n.result),n.onerror=t=>o(t)})}
    function filterProducts(){const t=document.getElementById("product-search").value.toLowerCase();document.querySelectorAll(".product-list").forEach(e=>{let o=!1;e.querySelectorAll(".product").forEach(e=>{e.querySelector("h3").textContent.toLowerCase().includes(t)?(e.style.display="flex",o=!0):e.style.display="none"});const n=e.closest(".promo-section");n&&(n.style.display=o?"block":"none")})}
    function sendFeedbackEmail(t){t.preventDefault();const e=document.getElementById("feedback-submit-btn"),o=document.getElementById("feedback-status");if("YOUR_SERVICE_ID"==='YOUR_SERVICE_ID'||"YOUR_TEMPLATE_ID"==='YOUR_TEMPLATE_ID')return o.textContent="Feedback form is not configured. Please contact the owner directly.",void(o.style.color="orange");e.disabled=!0,o.textContent="Sending...",o.style.color="blue"}
    function toggleCheckoutButton() { document.getElementById('checkout-btn').disabled = !document.getElementById('consent-checkbox').checked; }
    function showTab(tabId) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); const tab = document.getElementById(tabId); if (tab) tab.classList.add('active'); }

    // =================================================================
    // SECTION B: NEW E-SHOP ON-SCREEN CHATBOT & VERIFICATION LOGIC
    // =================================================================
    
    function toggleChatWidget(show) {
        const chatWidget = document.getElementById('eshop-chat-widget');
        const fabContainer = document.getElementById('fab-container');
        if (show) {
            chatWidget.classList.add('active');
            if(fabContainer) fabContainer.style.right = '400px'; 
        } else {
            chatWidget.classList.remove('active');
            if(fabContainer) fabContainer.style.right = '20px';
        }
    }
    
    function onProofUploaded(orderId, customerName, totalAmount, proofUrl, customerPhone) {
        document.getElementById('upload-status').innerHTML = `<p style="font-weight: bold; font-size: 1.2rem; color: var(--primary-color);">Kindly please wait, the payment is being verified by our admin...</p>`;
        document.getElementById('upload-proof-btn').style.display = 'none'; // Hide upload button

        // Start the 3-minute failover timer
        const failoverTimer = setTimeout(() => {
            const verificationPrompt = document.getElementById('verification-prompt');
            verificationPrompt.innerHTML = `<strong style="color: red;">Verification is taking longer than expected.</strong> We are redirecting you to our admin on WhatsApp to complete your order manually.`;
            const waMessage = `MANUAL ORDER VERIFICATION (TIMEOUT)\n\nOrder ID: ${orderId}\nCustomer: ${customerName}\nTotal: ${totalAmount}`;
            const waLink = `https://wa.me/601111033154?text=${encodeURIComponent(waMessage)}`;
            window.open(waLink, '_blank');
        }, 3 * 60 * 1000); // 3 minutes

        // Start polling for the approval status
        pollForApproval(orderId, failoverTimer);
    }

    async function handleAIChatSubmit() {
        const chatInput = document.getElementById('chat-input');
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        
        addChatMessage('user', userMessage);
        chatInput.value = '';
        addChatMessage('bot', "<i>The AI is thinking...</i>");

        try {
            const response = await fetch(botServerURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'askAI', data: { question: userMessage } })
            });
            const result = await response.json();
            const botMessages = document.querySelectorAll('.bot-message');
            botMessages[botMessages.length - 1].innerHTML = result.answer || "Sorry, I couldn't find an answer to that.";

        } catch (error) {
            const botMessages = document.querySelectorAll('.bot-message');
            botMessages[botMessages.length - 1].textContent = "Sorry, the AI assistant is currently unavailable.";
        }
    }

    function addChatMessage(sender, text) {
        const chatBody = document.getElementById('chat-body');
        if (!chatBody) return;
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender === 'bot' ? 'bot-message' : 'user-message');
        messageDiv.innerHTML = text; 
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function pollForApproval(orderId, failoverTimer) {
        const intervalId = setInterval(async () => {
            try {
                const response = await fetch(botServerURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'pollOrderStatus', data: { orderId: orderId } })
                });
                const result = await response.json();
                if (result.success && result.status === 'Approved') {
                    clearInterval(intervalId); // Stop this polling
                    clearTimeout(failoverTimer); // Stop the failover timer
                    
                    // Show the chatbot with the code
                    toggleChatWidget(true);
                    document.getElementById('chat-body').innerHTML = ''; // Clear chat
                    addChatMessage('bot', `Great news! Your payment has been approved. Here is your verification code to finalize the order:`);
                    
                    const codeResult = await fetch(botServerURL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getVerificationCode', data: { orderId: orderId } })
                    });
                    const codeData = await codeResult.json();

                    if(codeData.success){
                        addChatMessage('bot', `<strong>${codeData.code}</strong>`);
                        document.getElementById('verification-code').value = codeData.code;
                        document.getElementById('verification-prompt').innerHTML = `<h4 style="color:var(--accent-color);">Payment Approved!</h4><p>Your code has been delivered in the chat window. Please enter it below to finalize.</p>`;
                        toggleChatWidget(true); // Ensure widget is visible
                    } else {
                        document.getElementById('verification-prompt').innerHTML = `<p style="color: red;">Payment approved, but there was an issue getting your code. Please use the manual verification option.</p>`;
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
                // Don't stop polling on a single network error, it might recover.
            }
        }, 10000); // Poll every 10 seconds
    }
</script>

</body>
</html>
