<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forever Living by Muhd Arvind Isa</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root{--primary-color:#1a5276;--secondary-color:#f39c12;--accent-color:#27ae60;--light-gray:#f4f6f8;--dark-text:#333;--light-text:#fff;--border-radius:12px;--shadow:0 4px 15px rgba(0,0,0,.08);--font-family:'Poppins',sans-serif}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}@keyframes promoGlow{0%{box-shadow:0 0 5px rgba(243,156,18,.6)}50%{box-shadow:0 0 20px rgba(243,156,18,.9)}100%{box-shadow:0 0 5px rgba(243,156,18,.6)}}@keyframes marquee{0%{transform:translateX(0%)}100%{transform:translateX(-100%)}}
    *,::after,::before{box-sizing:border-box}
    body{font-family:var(--font-family);margin:0;padding:0;background-color:var(--light-gray);color:var(--dark-text);overflow-x:hidden;line-height:1.6;padding-top:45px}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}h1,h2,h3,h4{color:var(--primary-color);font-weight:600}
    .default-theme .hero-section{background:linear-gradient(135deg, #2c3e50, #4ca1af);color:var(--light-text);padding:80px 20px;text-align:center;border-radius:var(--border-radius);margin-bottom:30px;transition:all .5s ease;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .theme-HariRaya{background-color:#f0fff0}.theme-HariRaya .hero-section{background:linear-gradient(135deg, #006400, #daa520); border:4px dashed #FFD700;}.theme-HariRaya #promo-running-banner{background-color:#006400;color:#FFD700}
    .theme-Deepavali{background-color:#fff8e1}.theme-Deepavali .hero-section{background:linear-gradient(135deg, #ff6b6b, #feca57); border:4px dashed #ff9f43;}.theme-Deepavali #promo-running-banner{background-color:#e74c3c;color:#fff}
    .theme-Christmas{background-color:#f8f9fa}.theme-Christmas .hero-section{background:linear-gradient(135deg, #d32f2f, #388e3c); border:4px dashed #ffffff;}.theme-Christmas #promo-running-banner{background-color:#c62828;color:#fff}
    header{background-color:var(--light-text);padding:20px 0;text-align:center;border-bottom:1px solid #e0e0e0;position:relative}.header-content{display:flex;align-items:center;justify-content:center;gap:20px}.header-logo{width:80px;height:80px}.header-content h1{margin:0}.header-content h1 span{display:block}#promo-running-banner{color:var(--light-text);padding:10px 0;text-align:center;font-weight:700;font-size:1.1rem;position:fixed;top:0;left:0;width:100%;box-shadow:0 2px 5px rgba(0,0,0,.1);z-index:101;overflow:hidden;white-space:nowrap;display:none}#promo-running-banner .marquee-content{display:inline-block;padding-left:100%;animation:marquee 20s linear infinite}nav{background-color:var(--primary-color);position:sticky;top:45px;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.1)}nav ul{display:flex;list-style:none;padding:10px 0;margin:0;justify-content:center;flex-wrap:wrap}nav a{color:var(--light-text);text-decoration:none;font-weight:600;padding:10px 20px;display:inline-block;position:relative;transition:color .3s;cursor:pointer}nav a::after{content:'';position:absolute;bottom:5px;left:50%;transform:translateX(-50%);width:0;height:2px;background-color:var(--secondary-color);transition:width .3s}nav a:hover{color:#f1c40f}nav a:hover::after{width:60%}.tab-content{display:none;padding:20px 0}.tab-content.active{display:block;animation:fadeIn .5s}.hero-section h2{color:var(--light-text)}.ai-suggestion-box,.search-container{margin-bottom:30px}
    .promo-section h2 {font-size: 2rem; border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 25px;}
    .product-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:30px}.product{background:var(--light-text);border-radius:var(--border-radius);box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative;transition:all .3s ease;overflow:hidden}.product:hover{transform:translateY(-8px);box-shadow:0 10px 25px rgba(0,0,0,.12)}.product.promo-highlight{animation:promoGlow 2.5s infinite ease-in-out}.product-image-container{height:220px;padding:15px;display:flex;align-items:center;justify-content:center}.product img{max-width:100%;max-height:100%;object-fit:contain}.product-info{padding:20px;flex-grow:1;display:flex;flex-direction:column;text-align:left;position:relative}.product h3{margin:0 0 10px;font-size:1.25rem;height:3.75rem;overflow:hidden}.product .benefits{font-size:.85rem;color:#555;margin:10px 0;flex-grow:1}.product .consumption{font-size:.85rem;color:var(--primary-color);font-style:italic;margin:10px 0}.price-section{margin:15px 0;text-align:center}.original-price{text-decoration:line-through;color:#999;font-size:1rem;margin-right:10px}.new-price{color:var(--secondary-color);font-weight:700;font-size:1.5rem}.product-actions{margin-top:auto;display:flex;flex-direction:column;gap:10px}.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px 15px;border-radius:50px;text-decoration:none;font-weight:700;border:none;cursor:pointer;transition:all .3s}.btn:disabled{background-color:#ccc;cursor:not-allowed}.btn-primary{background:var(--primary-color);color:var(--light-text)}.btn-primary:hover{background:#123e5a;transform:scale(1.05)}.btn-secondary{background:var(--light-gray);color:var(--primary-color);border:1px solid var(--primary-color)}.btn-secondary:hover{background:#e0e0e0}.featured-badge{position:absolute;top:0;right:0;background:var(--secondary-color);color:#fff;padding:5px 25px;transform:rotate(45deg) translate(25%,-65%);transform-origin:0 0;font-weight:700;font-size:.9rem;box-shadow:0 3px 10px rgba(0,0,0,.2);z-index:10;white-space:nowrap}
    .halal-logo-tag{position:absolute;top:10px;left:10px;width:35px;height:35px;z-index:5}
    .floating-cart-btn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background-color:var(--primary-color);color:var(--light-text);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;box-shadow:0 4px 12px rgba(0,0,0,.25);cursor:pointer;z-index:1000;transition:transform .3s ease}.floating-cart-btn:hover{transform:scale(1.1)}#cart-count{position:absolute;top:-2px;right:-2px;background-color:var(--secondary-color);color:var(--light-text);border-radius:50%;padding:3px 8px;font-size:.8rem;font-weight:700;border:2px solid var(--light-text)}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);align-items:center;justify-content:center;animation:fadeIn .4s ease}.modal-content{background-color:#fefefe;padding:30px;border-radius:var(--border-radius);width:90%;max-width:600px;animation:slideIn .4s ease;max-height:90vh;overflow-y:auto}.close{color:#aaa;float:right;font-size:28px;font-weight:700;cursor:pointer;transition:color .3s}.close:hover{color:#000}#cart-items{max-height:250px;overflow-y:auto;padding-right:10px;border-bottom:1px solid #eee;margin-bottom:15px}.cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0}.cart-item-details{flex-grow:1}.quantity-controls{display:flex;align-items:center;gap:8px;margin-top:5px}.quantity-btn{width:28px;height:28px;background:var(--light-gray);border:1px solid #ccc;border-radius:50%;cursor:pointer;font-weight:700}.quantity-display{font-weight:600;min-width:20px;text-align:center}.remove-item-btn{font-size:1.2rem;color:#c00;cursor:pointer;margin-left:15px}.cart-summary{margin-top:20px;font-size:1.1rem}.summary-line{display:flex;justify-content:space-between;padding:8px 0}.summary-line.total{font-weight:700;font-size:1.3rem;border-top:2px solid #333;margin-top:10px}.points-earned,.free-shipping-promo{background-color:#e0f2f1;color:var(--accent-color);padding:10px;border-radius:8px;text-align:center;margin-top:20px;font-weight:700}.customer-info-form input{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ccc;border-radius:5px}.discount-section{display:flex;gap:10px;margin-top:15px}.discount-section input{flex-grow:1;padding:10px;border:1px solid #ccc;border-radius:5px}.discount-section button{width:auto;padding:10px 15px;flex-shrink:0}#discount-status{font-size:.9rem;font-weight:600;margin-top:8px;min-height:18px;text-align:center}#consent-form{margin-top:20px;padding:15px;background-color:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;font-size:.9rem}#consent-form label{display:flex;align-items:flex-start;gap:10px}#consent-form input[type=checkbox]{margin-top:3px}#consent-form a{color:var(--primary-color);font-weight:600}.checkout-btn{width:100%;margin-top:15px}.verification-step{margin-top:20px;padding:20px;background-color:var(--light-gray);border-radius:var(--border-radius);text-align:center;border:2px dashed #ddd}.verification-step.active{border-color:var(--primary-color);background-color:#eaf2f8}.verification-step.completed{border-color:var(--accent-color);background-color:#e8f8f5;opacity:.7}.verification-step h4{margin-top:0}.verification-step input[type=file],.verification-step input[type=text]{width:100%;padding:12px;margin:15px 0 10px;border:1px solid #ddd;border-radius:8px}#upload-status,#verification-status{margin-top:10px;font-weight:700;min-height:20px}footer{background:var(--primary-color);color:var(--light-text);padding:40px 20px;text-align:center;margin-top:30px}.disclaimer{margin-top:10px;background-color:#fff3cd;color:#856404;padding:15px;border-top:1px solid #ffeeba}
    .about-us-section{padding:40px;background-color:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow)}.about-us-section .owner-profile{display:flex;align-items:center;gap:30px;flex-wrap:wrap}.about-us-section .owner-image{width:150px;height:150px;border-radius:50%;object-fit:cover;border:5px solid var(--primary-color)}.about-us-section .owner-details{flex:1;min-width:300px}.contact-list{list-style:none;padding:0}.contact-list li{display:flex;align-items:center;gap:10px;margin-bottom:10px}.contact-list i{color:var(--primary-color);font-size:1.2rem;width:20px;text-align:center}
  </style>
</head>
<body class="default-theme">

<div id="store-wrapper">
  <header>
    <div class="container">
        <div class="header-content">
            <img src="FL.jpg" alt="Business Logo" class="header-logo" onerror="this.style.display='none'">
            <h1>
              FOREVER LIVING by Muhd Arvind Isa
              <span style="font-size: 1rem; color: #555; display: block; font-weight: 400;">Quality Wellness Products</span>
            </h1>
        </div>
    </div>
  </header>
  
  <div id="promo-running-banner">
      <div class="marquee-content" id="promo-banner-text"></div>
  </div>

  <nav>
    <div class="container">
        <ul id="main-nav">
          <li><a onclick="showTab('products')">Products</a></li>
          <li><a onclick="showTab('business')">Business Opportunity</a></li>
          <li><a onclick="showTab('about')">About Us</a></li>
          <li><a onclick="showTab('rewards')">Rewards</a></li>
        </ul>
    </div>
  </nav>

  <main id="main-content" class="container">
    <div id="products" class="tab-content active">
      <section class="hero-section" id="hero-section">
        <h2 id="hero-title"><i class="fa-solid fa-store"></i> Welcome to Our Store</h2>
        <p id="hero-subtitle">Enjoy high-quality wellness products for a healthier lifestyle.</p>
        <div id="countdown-timer" style="display:none;"></div>
      </section>

      <div class="search-container">
        <input type="text" id="product-search" onkeyup="filterProducts()" placeholder="Search for products by name...">
      </div>

      <section class="ai-suggestion-box">
        <h3><i class="fa-solid fa-robot"></i> AI Product Suggester</h3>
        <p>Describe your health concern (e.g., "dry skin", "low energy", "joint pain") and our AI will suggest a product for you.</p>
        <input type="text" id="symptom-input" placeholder="Enter your symptom or concern...">
        <button id="suggest-btn" class="btn btn-primary" onclick="suggestProduct()">Get Suggestion</button>
        <div id="suggestion-result"></div>
      </section>

      <div id="product-list-container">
          <p style="text-align: center; width: 100%;">Loading products...</p>
      </div>
    </div>

    <div id="business" class="tab-content">
      <section class="program-section">
        <h2>Build Your Forever Business</h2>
        <p style="text-align: center; max-width: 700px; margin: 0 auto 30px;">Join a community of entrepreneurs and build a business that offers financial freedom and a healthier lifestyle. With Forever Living, you get a proven business model, world-class products, and unparalleled support.</p>
        <a href="https://wa.me/601111033154?text=Hi,%20I'm%20interested%20in%20the%20Forever%20Living%20business%20opportunity." class="cta-button" target="_blank">Learn More & Get Started</a>
      </section>
    </div>

    <div id="about" class="tab-content">
      <section class="about-us-section">
        <h2>About Us</h2>
        <div class="owner-profile">
            <img src="owner.jpg" alt="Muhd Arvind Isa" class="owner-image" onerror="this.src='https://via.placeholder.com/150'">
            <div class="owner-details">
                <h3>Muhd Arvind Isa - Independent FBO</h3>
                <p>Welcome! I am an authorized Independent Forever Business Owner (FBO) dedicated to bringing you the highest quality health and wellness products from Forever Living. My mission is to empower individuals to lead healthier lives and to provide opportunities for financial well-being through the Forever business model.</p>
                <p><strong>Powered by:</strong> Rich Academy Global</p>
                <p><strong>Contact Information:</strong></p>
                <ul class="contact-list">
                    <li><i class="fab fa-whatsapp"></i><a href="https://wa.me/601111033154">+6011 1103 3154</a></li>
                    <li><i class="fa-solid fa-envelope"></i><a href="mailto:arvin8786@gmail.com">arvin8786@gmail.com</a></li>
                    <li><i class="fa-solid fa-headset"></i><a href="mailto:cs.foreverlivingbymuhdarvindisa@gmail.com">cs.foreverlivingbymuhdarvindisa@gmail.com</a> (Customer Service)</li>
                </ul>
            </div>
        </div>
        <hr style="margin: 30px 0;">
        <h4>Our Commitment</h4>
        <p>We are committed to providing authentic Forever Living products, exceptional customer service, and reliable support for both our customers and business partners. All products featured on this website are sourced directly from Forever Living Products and are guaranteed to be genuine.</p>
      </section>
    </div>

    <div id="rewards" class="tab-content">
      <section class="program-section">
            <h2><i class="fa-solid fa-award"></i> Redeem Your Points</h2>
            <p style="text-align: center;">This feature is currently under development. Stay tuned for exciting rewards!</p>
            <div class="rewards-grid">
                <div class="reward-item">
                    <img src="rm5.jpg" alt="RM 5 Voucher" onerror="this.src='https://i.imgur.com/O9yP2aH.png'">
                    <h4>RM 5 Voucher</h4>
                    <p class="points-cost">500 Points</p>
                    <div class="coming-soon-overlay"><span>Coming Soon</span></div>
                </div>
                <div class="reward-item">
                    <img src="rm10.jpg" alt="RM 10 Voucher" onerror="this.src='https://i.imgur.com/sY2a2qG.png'">
                    <h4>RM 10 Voucher</h4>
                    <p class="points-cost">1000 Points</p>
                    <div class="coming-soon-overlay"><span>Coming Soon</span></div>
                </div>
                <div class="reward-item">
                    <img src="rm20.jpg" alt="RM 20 Voucher" onerror="this.src='https://i.imgur.com/Jz4Y8fW.png'">
                    <h4>RM 20 Voucher</h4>
                    <p class="points-cost">2000 Points</p>
                    <div class="coming-soon-overlay"><span>Coming Soon</span></div>
                </div>
                <div class="reward-item">
                    <img src="aloe-vera-gel.jpg" alt="Aloe Vera Gel">
                    <h4>ALOE VERA GEL</h4>
                    <p class="points-cost">10000 Points</p>
                    <div class="coming-soon-overlay"><span>Coming Soon</span></div>
                </div>
            </div>
        </section>
    </div>
  </main>

  <footer class="footer">
      <div class="container">
        <p>© 2025 Forever Living by Muhd Arvind Isa. All rights reserved.</p>
        <div class="timestamp">Last updated: <span id="current-date"></span></div>
        <section class="disclaimer">
          <strong>Disclaimer:</strong> This website is operated by an independent Registered Forever Business Owner (FBO) and is not the official site of Forever Living Products.
        </section>
      </div>
  </footer>
</div>

  <div id="floating-cart" class="floating-cart-btn" onclick="toggleCart()">
    <i class="fa-solid fa-cart-shopping"></i>
    <span id="cart-count">0</span>
  </div>

  <div id="cart-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="toggleCart(true)">×</span>
      <div id="cart-view">
        <h2>Your Shopping Cart</h2>
        <div id="cart-items"><p>Your cart is currently empty.</p></div>
        <div class="cart-summary">
          <div class="summary-line"><span>Subtotal</span><span id="cart-subtotal">RM 0.00</span></div>
          <div class="summary-line" id="discount-line" style="display:none;"><span>Discount</span><span id="cart-discount">RM 0.00</span></div>
          <div class="summary-line"><span>Shipping</span><span id="cart-shipping">RM 0.00</span></div>
          <div class="summary-line total"><span>Total</span><span id="cart-total">RM 0.00</span></div>
          <div id="points-earned-display"></div>
        </div>
        <div class="discount-section">
            <input type="text" id="discount-code-input" placeholder="Enter Discount Code">
            <button class="btn btn-secondary" onclick="applyDiscount()">Apply</button>
        </div>
        <p id="discount-status"></p>
        <div class="customer-info-form">
          <h3 style="margin-top: 20px;">Customer & Shipping Information</h3>
          <input type="text" id="customer-name" placeholder="Your Full Name" required>
          <input type="tel" id="customer-phone" placeholder="Your WhatsApp Number (e.g., 60123456789)" required>
          <input type="email" id="customer-email" placeholder="Your Email Address (for receipt)" required>
          <input type="text" id="customer-address1" placeholder="Address Line 1" required>
          <input type="text" id="customer-address2" placeholder="Address Line 2 (Optional)">
          <input type="text" id="customer-city" placeholder="City" required>
          <input type="text" id="customer-state" placeholder="State" required>
          <input type="text" id="customer-postcode" placeholder="Postcode" required>
        </div>
        <div id="consent-form">
            <label for="consent-checkbox">
                <input type="checkbox" id="consent-checkbox" onchange="toggleCheckoutButton()">
                <span>I consent to the collection and use of my personal data for the sole purpose of processing this transaction. You can request data deletion at any time via <a href="mailto:cs.foreverlivingbymuhdarvindisa@gmail.com?subject=Request%20for%20Data%20Deletion">Customer Service Email</a>.</span>
            </label>
        </div>
        <button class="btn btn-primary checkout-btn" id="checkout-btn" onclick="initiateCheckout()" disabled>Agree & Complete Order via WhatsApp</button>
        <div class="free-shipping-promo">🚚 Default shipping rates apply. Free shipping on select promotions or orders over RM 250!</div>
      </div>
      <div id="verification-view" style="display: none;">
        <h2>Order Verification</h2>
        <p>Please complete the following steps to finalize your order.</p>
        <div id="proof-upload-step" class="verification-step active">
            <h4><i class="fa-solid fa-arrow-up-from-bracket"></i> Step 1: Upload Payment Proof</h4>
            <p style="font-size: 0.9rem; color: #555;">Upload a screenshot of your transaction receipt.</p>
            <input type="file" id="payment-proof-upload" accept="image/*">
            <button class="btn btn-primary" id="upload-proof-btn" onclick="uploadProof()">Upload and Proceed</button>
            <p id="upload-status"></p>
        </div>
        <div id="code-verification-step" class="verification-step">
            <h4><i class="fa-solid fa-key"></i> Step 2: Finalize with Code</h4>
            <p style="font-size: 0.9rem; color: #555;">Enter the verification code provided to you by the owner.</p>
            <input type="text" id="verification-code" placeholder="Enter Verification Code" disabled>
            <button class="btn btn-primary" id="finalize-order-btn" onclick="finalizeOrder()" disabled>Finalize Order & Get Receipt</button>
            <p id="verification-status"></p>
        </div>
        <button class="btn btn-secondary" style="margin-top: 20px;" onclick="cancelVerification()">Cancel Entire Order</button>
      </div>
    </div>
  </div>

<script>
    // --- CONFIGURATION ---
    const googleScriptURL = 'https://script.google.com/macros/s/AKfycbyNql7q0khksErHPDmALIcOzGtmd5IfFoPJUY9_j8cpVesD5VqubLRonKdKjZV6BRP51g/exec';
    
    // --- DATA ---
    const products = [ { id: 1, name: "ALOE VERA GEL", price: 116.79, specialPromo: true, image: "aloe-vera-gel.jpg", benefits: "Pure inner leaf aloe vera gel. Supports healthy digestion, promotes a healthy immune system, enhances nutrient absorption, and helps maintain natural energy levels. Contains 99.7% pure aloe.", consumption: "Take 30-60ml daily." }, { id: 2, name: "ALOE BERRY NECTAR", price: 116.79, specialPromo: true, image: "aloe-berry-nectar.jpg", benefits: "A burst of cranberries and sweet apples provides a sweet and tangy flavor. Supports urinary health, contains powerful antioxidants, and promotes a healthy immune system. A natural source of Vitamin C.", consumption: "30-60ml daily." }, { id: 3, name: "ALOE BITS N' PEACHES", price: 116.79, specialPromo: true, image: "aloe-peaches.jpg", benefits: "Combines pure aloe vera with sun-ripened peaches. Great for kids and families. Aids in digestive health, supports the immune system, and provides valuable carotenoids and vitamins. Great taste.", consumption: "30-60ml daily." }, { id: 4, name: "LITE VANILLA", price: 155.72, promoPrice: 147.93, image: "lite-vanilla.jpg", benefits: "Meal replacement for weight management.", consumption: "Mix with milk or water." }, { id: 5, name: "LITE CHOCO", price: 155.72, promoPrice: 147.93, image: "lite-choco.jpg", benefits: "Meal replacement for weight management.", consumption: "Mix with milk or water." }, { id: 6, name: "SUPERGREENS", price: 214.71, promoPrice: 203.97, image: "supergreens.jpg", benefits: "Rich in antioxidants and nutrients. Detoxification.", consumption: "Mix with water or juice." }, { id: 7, name: "FIBER", price: 124.44, promoPrice: 118.22, image: "fiber.jpg", benefits: "Supports digestive health.", consumption: "Mix with water." }, { id: 8, name: "TONGKAT ALI", price: 19.90, promoPrice: 19.57, image: "tongkat-ali.jpg", benefits: "Supports men's health and vitality.", consumption: "As per packaging." }, { id: 9, name: "WHITE COFFEE", price: 15.99, promoPrice: 15.72, image: "white-coffee.jpg", benefits: "Rich and aromatic coffee.", consumption: "Mix with hot water." }, { id: 10, name: "CHOCOLATE MALT DRINK", price: 27.90, promoPrice: 27.20, image: "choco-malt.jpg", benefits: "Nutritious chocolate malt drink.", consumption: "Mix with hot water or milk." }, { id: 11, name: "TEH TARIK HALIA", price: 25.90, promoPrice: 25.25, image: "teh-tarik.jpg", benefits: "Ginger tea for warmth and digestion.", consumption: "Mix with hot water." }, { id: 12, name: "BEE HONEY", price: 132.57, promoPrice: 125.94, image: "bee-honey.jpg", benefits: "Natural energy and soothes throat.", consumption: "1-2 teaspoons daily." }, { id: 13, name: "BEE POLLEN", price: 75.50, promoPrice: 71.73, image: "bee-pollen.jpg", benefits: "Natural multivitamin and energy booster.", consumption: "1 tablet 3 times daily." }, { id: 14, name: "BEE PROPOLIS", price: 139.21, promoPrice: 132.25, image: "bee-propolis.jpg", benefits: "Immune support, natural antibiotic.", consumption: "1 tablet daily." }, { id: 15, name: "ROYAL GELLY", price: 139.21, promoPrice: 132.25, image: "royal-jelly.jpg", benefits: "Energy booster, supports immune system.", consumption: "1 tablet daily." }, { id: 16, name: "OMEGA 3 PLUS", price: 130.10, promoPrice: 123.60, image: "arctic-sea.jpg", benefits: "Supports heart and brain health.", consumption: "2 softgels twice daily." }, { id: 17, name: "ABSORBENT-C", price: 75.50, promoPrice: 71.73, image: "absorbent-c.jpg", benefits: "Immune support, antioxidant.", consumption: "1-2 tablets daily." }, { id: 18, name: "FIELDS OF GREENS", price: 86.10, promoPrice: 81.80, image: "fields-of-greens.jpg", benefits: "Detoxification and digestion support.", consumption: "1 tablet 3 times daily." }, { id: 19, name: "CALCIUM PLUS TABLET", price: 132.15, promoPrice: 125.54, image: "calcium-plus.jpg", benefits: "Supports bone health.", consumption: "2 tablets daily." }, { id: 20, name: "ALOE LIPS", price: 20.33, promoPrice: 19.31, image: "aloe-lips.jpg", benefits: "Moisturizes and protects lips.", consumption: "Apply as needed." }, { id: 21, name: "BRIGHT TOOTHGEL", price: 41.29, promoPrice: 39.23, image: "bright-toothgel.jpg", benefits: "Fluoride-free, gentle on gums.", consumption: "Brush teeth twice daily." }, { id: 22, name: "ALOE FIRST", price: 90.83, promoPrice: 86.29, image: "aloe-first.jpg", benefits: "Soothes skin irritations.", consumption: "Spray on skin as needed." }, { id: 23, name: "DEODORANT STICK", price: 50.73, promoPrice: 48.19, image: "forever-deodorant.jpg", benefits: "Long-lasting protection.", consumption: "Apply daily." }, { id: 24, name: "AVOCADO SOAP", price: 30.68, promoPrice: 29.15, image: "avocado-soap.jpg", benefits: "Gentle cleansing for face and body skin.", consumption: "Use daily." }, { id: 25, name: "ALOE LIQUID SOAP", price: 120.91, promoPrice: 114.86, image: "aloe-liquid-soap.jpg", benefits: "Moisturizing hand and face skin wash.", consumption: "Use daily." }, { id: 26, name: "JOJOBA SHAMPOO", price: 105.93, promoPrice: 100.63, image: "aloe-jojoba-shampoo.jpg", benefits: "Nourishes hair and scalp.", consumption: "Massage into wet hair." }, { id: 27, name: "JOJOBA CONDITIONER", price: 117.70, promoPrice: 111.82, image: "aloe-jojoba-conditioner.jpg", benefits: "Moisturizes and strengthens hair.", consumption: "Apply after shampoo." }, { id: 28, name: "ALOE BODY WASH", price: 120.91, promoPrice: 114.86, image: "aloe-body-wash.jpg", benefits: "Gentle, moisturizing body skin wash.", consumption: "Use daily in shower." }, { id: 29, name: "ALOE BODY LOTION", price: 112.35, promoPrice: 106.73, image: "aloe-body-lotion.jpg", benefits: "Hydrates and softens skin.", consumption: "Apply to body as needed." }, { id: 30, name: "ALOE PROPOLIS CREME", price: 90.83, promoPrice: 86.29, image: "aloe-propolis-creme.jpg", benefits: "Soothes and moisturizes dry skin.", consumption: "Apply generously." }, { id: 31, name: "ALOE VERA GELLY", price: 70.78, promoPrice: 67.24, image: "aloe-vera-gelly.jpg", benefits: "Soothes minor skin irritations.", consumption: "Apply to affected area." }, { id: 32, name: "ALOE MOISTURIZING", price: 70.78, promoPrice: 67.24, image: "aloe-moisturizing.jpg", benefits: "Hydrates face and body skin.", consumption: "Apply as needed." }, { id: 33, name: "ALOE MASSAGE LOTION", price: 70.78, promoPrice: 67.24, image: "aloe-massage-lotion.jpg", benefits: "Soothing lotion for massage.", consumption: "Massage into skin." }, { id: 34, name: "ALOE MSM GEL", price: 86.00, promoPrice: 81.70, image: "aloe-msm-gel.jpg", benefits: "Soothes joints and muscles.", consumption: "Apply to affected areas." }, { id: 35, name: "ALOE SUNSCREEN", price: 89.07, promoPrice: 84.62, image: "aloe-sunscreen.jpg", benefits: "UV protection with aloe for skin.", consumption: "Apply before sun exposure." }, { id: 36, name: "ALOE SCRUB", price: 77.86, promoPrice: 73.97, image: "aloe-scrub.jpg", benefits: "Gently exfoliates skin.", consumption: "Use 2-3 times a week." }, { id: 37, name: "MASK POWDER", price: 102.90, promoPrice: 97.76, image: "mask-powder.jpg", benefits: "Cleanses and tightens pores.", consumption: "Mix with Aloe Activator." }, { id: 38, name: "R3 FACTOR-SKIN DEFENSE", price: 160.97, promoPrice: 152.92, image: "r3-factor.jpg", benefits: "Helps skin retain moisture.", consumption: "Apply to face and neck." }, { id: 39, name: "FOREVER ALPHA-E FACTOR", price: 144.90, promoPrice: 137.66, image: "alpha-e-factor.jpg", benefits: "Nourishes and restores skin.", consumption: "Apply a few drops to face." }, { id: 40, name: "INFINITE HYDRATING CLEANSER", price: 131.20, promoPrice: 124.64, image: "infinite-cleanser.jpg", benefits: "Gentle, hydrating skin cleanser.", consumption: "Use morning and night." }, { id: 41, name: "INFINITE FIRMING SERUM", price: 190.47, promoPrice: 180.95, image: "infinite-serum.jpg", benefits: "Reduces appearance of fine lines.", consumption: "Apply to face." }, { id: 42, name: "INFINITE RESTORING CREME", price: 221.56, promoPrice: 210.48, image: "infinite-creme.jpg", benefits: "Deeply moisturizes and restores skin.", consumption: "Apply to face and neck." }, { id: 43, name: "BALANCING TONER", price: 106.18, promoPrice: 100.87, image: "balancing-toner.jpg", benefits: "Refreshes and balances skin.", consumption: "Apply after cleansing." }, { id: 44, name: "AWAKENING EYE CREAM", price: 89.66, promoPrice: 85.18, image: "eye-cream.jpg", benefits: "Reduces puffiness and dark circles.", consumption: "Pat gently around eyes." }, { id: 45, name: "ALOE ACTIVATOR", price: 80.59, promoPrice: 76.56, image: "aloe-activator.jpg", benefits: "Cleanses, soothes and refreshes skin.", consumption: "Use with Mask Powder." }, { id: 46, name: "HYDRATING SERUM", price: 156.56, promoPrice: 148.73, image: "hydrating-serum.jpg", benefits: "Boosts skin hydration.", consumption: "Apply to face." }, { id: 47, name: "S.REFRESHING G.CLEANSER", price: 115.61, promoPrice: 109.83, image: "refreshing-cleanser.jpg", benefits: "Gentle gel skin cleanser.", consumption: "Use morning and night." }, { id: 48, name: "S. IILUMINATING GEL", price: 107.35, promoPrice: 102.00, image: "illuminating-gel.jpg", benefits: "Brightens skin appearance.", consumption: "Apply to face." }, { id: 49, "name": "S. REFINING GEL MASK", price: 115.61, promoPrice: 109.83, image: "refining-mask.jpg", benefits: "Refines pores and moisturizes skin.", consumption: "Use 2-3 times a week." }, { id: 50, name: "S.SMOOTHING GEL MOISTURIZER", price: 115.76, promoPrice: 109.97, image: "smoothing-moisturizer.jpg", benefits: "Lightweight gel moisturizer for skin.", consumption: "Apply to face." }, { id: 51, name: "ALOE BIO-CELLULOSE MASK", price: 146.00, promoPrice: 138.70, image: "bio-cellulose-mask.jpg", benefits: "Deeply hydrates and conditions skin.", consumption: "Use once a week." }, { id: 52, name: "REPLENISHING SKIN OIL", price: 132.00, promoPrice: 125.40, image: "skin-oil.jpg", benefits: "Nourishes with a blend of oils for skin.", consumption: "Apply a few drops to face." }, { id: 53, name: "PROTECTING DAY LOTION", price: 167.99, promoPrice: 159.59, image: "day-lotion.jpg", benefits: "Moisturizes and protects skin with SPF.", consumption: "Apply in the morning." },
    ];
    
    // --- GLOBAL STATE ---
    let cart = [];
    let activeFestival = null;
    let activePromotions = [];
    let shippingRules = {};
    let availableDiscountCodes = {};
    let appliedDiscount = null;

    // --- INITIALIZATION & UI ---
    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        try {
            const response = await fetch(googleScriptURL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') {
                activeFestival = data.activeFestival;
                activePromotions = data.activePromotions;
                shippingRules = data.shippingRules;
                availableDiscountCodes = data.discountCodes;
            } else { throw new Error(data.message || 'Failed to fetch initial data.'); }
        } catch (error) { console.error("Error fetching dynamic data:", error); }
        initializeUI();
        if (sessionStorage.getItem('pendingOrder')) toggleCart();
        else showTab('products');
    });

    function initializeUI() {
        const body = document.body; body.className = 'default-theme';
        if (activeFestival) {
            body.classList.add(`theme-${activeFestival.theme}`);
            document.getElementById('hero-title').innerHTML = `<i class="fa-solid fa-gift"></i> ${activeFestival.name}`;
            document.getElementById('hero-subtitle').textContent = "Enjoy special festive offers!";
            const banner = document.getElementById('promo-running-banner');
            document.getElementById('promo-banner-text').textContent = `✨ ${activeFestival.name}! See special offers below! ✨`;
            banner.style.display = 'block';
        } else {
            document.getElementById('hero-title').innerHTML = `<i class="fa-solid fa-store"></i> Welcome to Our Store`;
            document.getElementById('hero-subtitle').textContent = "Enjoy high-quality wellness products for a healthier lifestyle.";
        }
        renderProducts();
    }
    
    function renderProducts() {
        const productListContainer = document.getElementById("product-list-container");
        if (!productListContainer) return;
        let html = ""; let remainingProducts = [...products];
        activePromotions.forEach(promo => {
            let productsInPromo = remainingProducts.filter(p => promo.productIDs.includes(p.id));
            if (productsInPromo.length > 0) {
                html += `<section class="promo-section"><h2>${promo.description}</h2><div class="product-list">`;
                productsInPromo.forEach(product => { html += renderSingleProduct(product, true); });
                html += `</div></section>`;
                remainingProducts = remainingProducts.filter(p => !promo.productIDs.includes(p.id));
            }
        });
        if (remainingProducts.length > 0) {
            html += `<section class="promo-section"><h2>All Products</h2><div class="product-list">`;
            remainingProducts.forEach(product => { html += renderSingleProduct(product, false); });
            html += `</div></section>`;
        }
        productListContainer.innerHTML = html;
    }

    function renderSingleProduct(product, isPromo) {
        const <img src='halal.png';
        let priceHTML = `<span class="new-price">RM ${product.price.toFixed(2)}</span>`;
        if (isPromo && product.promoPrice) priceHTML = `<span class="original-price">RM ${product.price.toFixed(2)}</span><span class="new-price">RM ${product.promoPrice.toFixed(2)}</span>`;
        else if (isPromo && product.specialPromo) priceHTML = `<span class="original-price">RM ${product.price.toFixed(2)}</span><span class="new-price" style="font-size: 1.2rem; color: var(--primary-color); display: block; margin-top: 5px;">Buy Any 2 for RM 200.00</span><div style="font-size: 0.9rem; color: var(--accent-color); font-weight: bold; margin-top: 5px;"><i class="fa-solid fa-truck-fast"></i> FREE Shipping!</div>`;
        return `<div class="product ${isPromo ? 'promo-highlight' : ''}" data-product-id="${product.id}" data-product-name="${product.name}"><img src="${halalLogoUrl}" alt="Halal Certified" class="halal-logo-tag" onerror="this.style.display='none'">${isPromo ? '<div class="featured-badge">On Offer!</div>' : ''}<div class="product-image-container"><img src="${product.image || 'https://via.placeholder.com/200'}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/200x200?text=Image+Not+Found'"></div><div class="product-info"><h3>${product.name}</h3><div class="price-section">${priceHTML}</div><div class="benefits"><strong>Benefits:</strong> ${product.benefits}</div><div class="consumption"><strong>Usage:</strong> ${product.consumption}</div><div class="product-actions"><button class="btn btn-primary" onclick="addToCart(${product.id})"><i class="fa-solid fa-cart-plus"></i> Add to Cart</button></div></div></div>`;
    }

    function showTab(tabId){document.querySelectorAll(".tab-content").forEach(el=>el.classList.remove("active"));document.getElementById(tabId)?.classList.add("active")}
    function toggleCheckoutButton(){document.getElementById("checkout-btn").disabled=!document.getElementById("consent-checkbox").checked}
    
    // --- CART LOGIC ---
    function addToCart(productId){const existingItem=cart.find(item=>item.id===productId);if(existingItem){existingItem.quantity++}else{const productData=products.find(p=>p.id===productId);cart.push({id:productData.id,name:productData.name,price:productData.price,quantity:1})}updateCartDisplay()}
    function increaseQuantity(productId){const item=cart.find(p=>p.id===productId);if(item){item.quantity++;updateCartDisplay()}}
    function decreaseQuantity(productId){const item=cart.find(p=>p.id===productId);if(item){item.quantity--;if(item.quantity<=0)removeItemFromCart(productId);else updateCartDisplay()}}
    function removeItemFromCart(productId){appliedDiscount=null;document.getElementById('discount-code-input').value="";document.getElementById('discount-status').textContent="";cart=cart.filter(p=>p.id!==productId);updateCartDisplay()}
    function updateCartCount(){document.getElementById("cart-count").textContent=cart.reduce((total,item)=>total+item.quantity,0)}
    function applyDiscount(){const codeInput=document.getElementById("discount-code-input"),statusEl=document.getElementById("discount-status"),code=codeInput.value.trim().toUpperCase();if(!code)return statusEl.textContent="Please enter a code.",statusEl.style.color="orange";const discountData=availableDiscountCodes[code];if(discountData){appliedDiscount={code,...discountData};statusEl.textContent=`Code "${code}" applied successfully!`;statusEl.style.color="green"}else{appliedDiscount=null;statusEl.textContent="Invalid or expired discount code.";statusEl.style.color="red"}updateCartDisplay()}
    
    // --- CALCULATION LOGIC ---
    function calculateCartTotals() { let subtotal = 0; let promoShippingRuleId = null; const itemPrices = {}; cart.forEach(item => { itemPrices[item.id] = { finalPrice: products.find(p => p.id === item.id).price, promoApplied: false }; }); activePromotions.forEach(promo => { let productsInPromoInCart = cart.filter(item => promo.productIDs.includes(item.id)); if (productsInPromoInCart.length === 0) return; if (promo.shippingRuleId) promoShippingRuleId = promo.shippingRuleId; if (promo.type === 'B2G200') { const count = productsInPromoInCart.reduce((sum, item) => sum + item.quantity, 0); const numPairs = Math.floor(count / 2); subtotal += numPairs * 200; const remainingSingles = count % 2; if (remainingSingles > 0) subtotal += products.find(p => p.id === productsInPromoInCart[0].id).price * remainingSingles; productsInPromoInCart.forEach(item => { itemPrices[item.id].promoApplied = true; }); } else if (promo.type === 'PERCENT') { productsInPromoInCart.forEach(item => { const basePrice = products.find(p => p.id === item.id).price; itemPrices[item.id].finalPrice = basePrice * (1 - parseFloat(promo.value) / 100); itemPrices[item.id].promoApplied = true; }); } else if (promo.type === 'FIXED') { productsInPromoInCart.forEach(item => { const basePrice = products.find(p => p.id === item.id).price; itemPrices[item.id].finalPrice = basePrice - parseFloat(promo.value); itemPrices[item.id].promoApplied = true; }); } }); cart.forEach(item => { if (!itemPrices[item.id].promoApplied) { subtotal += itemPrices[item.id].finalPrice * item.quantity; } else if (itemPrices[item.id].promoApplied && activePromotions.find(p => p.productIDs.includes(item.id))?.type !== 'B2G200') { subtotal += itemPrices[item.id].finalPrice * item.quantity; } }); let discountValue = 0; if (appliedDiscount) { if (appliedDiscount.type === 'Fixed') discountValue = parseFloat(appliedDiscount.value); else if (appliedDiscount.type === 'Percentage') discountValue = subtotal * (parseFloat(appliedDiscount.value) / 100); } const subtotalAfterDiscount = subtotal - discountValue; const shipping = calculateShipping(cart, subtotalAfterDiscount, promoShippingRuleId); const total = subtotalAfterDiscount + shipping.fee; const totalPoints = Math.floor(subtotalAfterDiscount); return { subtotal, discountValue, shipping, total, totalPoints }; }

    function calculateShipping(cart, subtotal, promoShippingRuleId) {
        if (cart.length === 0) return { fee: 0, message: "RM 0.00" };
        if (subtotal >= 250) return { fee: 0, message: "FREE" };
        if (promoShippingRuleId && shippingRules[promoShippingRuleId]) {
            const rule = shippingRules[promoShippingRuleId];
            if (rule.type === 'Free') return { fee: 0, message: "FREE" };
            if (rule.type === 'FlatRate') return { fee: parseFloat(rule.charge), message: `RM ${parseFloat(rule.charge).toFixed(2)}` };
        }
        const defaultRules = Object.values(shippingRules).filter(r => r.isDefault && r.type === 'Tiered').sort((a, b) => a.minSpend - b.minSpend);
        for (const rule of defaultRules) if (subtotal >= rule.minSpend && subtotal <= rule.maxSpend) return { fee: parseFloat(rule.charge), message: parseFloat(rule.charge) === 0 ? "FREE" : `RM ${parseFloat(rule.charge).toFixed(2)}` };
        return { fee: 14, message: "RM 14.00" };
    }

    function updateCartDisplay(){const cartItemsEl=document.getElementById("cart-items"),subtotalEl=document.getElementById("cart-subtotal"),discountLine=document.getElementById("discount-line"),discountEl=document.getElementById("cart-discount"),shippingEl=document.getElementById("cart-shipping"),totalEl=document.getElementById("cart-total"),pointsEl=document.getElementById("points-earned-display");if(cart.length===0){cartItemsEl.innerHTML="<p>Your cart is currently empty.</p>";subtotalEl.textContent="RM 0.00";shippingEl.textContent="RM 0.00";totalEl.textContent="RM 0.00";pointsEl.innerHTML="";discountLine.style.display="none";updateCartCount();return}const{subtotal:calculatedSubtotal,discountValue:calculatedDiscount,shipping:shipping,total:total,totalPoints:totalPoints}=calculateCartTotals();let itemsHTML="";cart.forEach(item=>{const productData=products.find(p=>p.id===item.id);itemsHTML+=`<div class="cart-item"><div class="cart-item-details"><strong>${item.name}</strong><div class="quantity-controls"><button class="quantity-btn" onclick="decreaseQuantity(${item.id})">-</button><span class="quantity-display">${item.quantity}</span><button class="quantity-btn" onclick="increaseQuantity(${item.id})">+</button></div></div><div style="display:flex;align-items:center;gap:15px"><span>RM ${productData.price.toFixed(2)}/pc</span><span class="remove-item-btn" onclick="removeItemFromCart(${item.id})">×</span></div></div>`});cartItemsEl.innerHTML=itemsHTML;subtotalEl.textContent=`RM ${calculatedSubtotal.toFixed(2)}`;if(calculatedDiscount>0){discountEl.textContent=`- RM ${calculatedDiscount.toFixed(2)}`;discountLine.style.display="flex"}else{discountLine.style.display="none"}shipping.message==="FREE"?shippingEl.innerHTML='<span style="color:var(--accent-color);font-weight:700"><i class="fa-solid fa-truck-fast"></i> FREE!</span>':shippingEl.textContent=shipping.message;totalEl.textContent=`RM ${total.toFixed(2)}`;pointsEl.innerHTML=`<div class="points-earned"><i class="fa-solid fa-star"></i> Points to be Earned: ${totalPoints}</div>`;updateCartCount()}
    
    // --- CHECKOUT AND VERIFICATION FLOW ---
    function initiateCheckout(){if(!document.getElementById("consent-checkbox").checked)return void alert("You must agree to the data collection consent before proceeding.");const name=document.getElementById("customer-name").value.trim(),phone=document.getElementById("customer-phone").value.trim(),email=document.getElementById("customer-email").value.trim(),address1=document.getElementById("customer-address1").value.trim(),address2=document.getElementById("customer-address2").value.trim(),city=document.getElementById("customer-city").value.trim(),state=document.getElementById("customer-state").value.trim(),postcode=document.getElementById("customer-postcode").value.trim();if(!name||!phone||!email||!address1||!city||!state||!postcode)return void alert("Please fill in all required customer and shipping information fields.");if(0===cart.length)return void alert("Your cart is empty.");const{subtotal,discountValue,shipping,total,totalPoints}=calculateCartTotals();const fullAddress=`${address1}, ${address2?address2+", ":""}${postcode} ${city}, ${state}.`;const pendingOrder={customerName:name,customerPhone:phone,customerEmail:email,customerAddress:fullAddress,cart:cart.map(item=>{const p=products.find(prod=>prod.id===item.id);return{id:item.id,name:item.name,quantity:item.quantity,price:p.price}}),subtotal,discountValue,shippingFee:shipping.fee,totalAmount:total,discountCodeUsed:appliedDiscount?appliedDiscount.code:"N/A",totalPointsForThisPurchase:totalPoints,proofUploaded:!1};sessionStorage.setItem("pendingOrder",JSON.stringify(pendingOrder));let message=`Hi, I would like to place an order:\n\n*Customer Details:*\nName: ${name}\nPhone: ${phone}\nEmail: ${email}\nAddress: ${fullAddress}\n\n--- ORDER SUMMARY ---\nSubtotal: RM ${subtotal.toFixed(2)}${discountValue>0?`\nDiscount (${appliedDiscount.code}): - RM ${discountValue.toFixed(2)}`:""}\nShipping: ${shipping.message}\n*TOTAL: RM ${total.toFixed(2)}*\n\nPlease provide payment details. After payment, I will upload the proof and verification code on your website to finalize the order. Thank you!`;window.open(`https://wa.me/601111033154?text=${encodeURIComponent(message)}`,"_blank"),document.getElementById("cart-view").style.display="none",document.getElementById("verification-view").style.display="block",updateVerificationUI()}
    async function uploadProof(){const proofFile=document.getElementById("payment-proof-upload").files[0],uploadStatusEl=document.getElementById("upload-status"),uploadBtn=document.getElementById("upload-proof-btn");let pendingOrder=JSON.parse(sessionStorage.getItem("pendingOrder"));if(!proofFile)return uploadStatusEl.textContent="Please select a file to upload.",uploadStatusEl.style.color="red";if(!pendingOrder)return uploadStatusEl.textContent="Error: No pending order found.",uploadStatusEl.style.color="red";uploadBtn.disabled=!0,uploadStatusEl.textContent="Uploading...",uploadStatusEl.style.color="blue";try{const base64File=await getBase64(proofFile),payload={action:"logInitialOrderWithProof",...pendingOrder,paymentProofFile:base64File.split(",")[1],paymentProofMimeType:proofFile.type,paymentProofFileName:`${pendingOrder.customerEmail.split("@")[0]}-${Date.now()}`,itemsPurchased:pendingOrder.cart.map(item=>`${item.name} (x${item.quantity})`).join("; ")},response=await fetch(googleScriptURL,{method:"POST",body:JSON.stringify(payload)}),result=await response.json();if("success"===result.status){uploadStatusEl.textContent="Proof uploaded successfully!";uploadStatusEl.style.color="green";pendingOrder.proofUploaded=!0;sessionStorage.setItem("pendingOrder",JSON.stringify(pendingOrder));updateVerificationUI()}else throw new Error(result.message)}catch(error){uploadStatusEl.textContent=`Error: ${error.message}`;uploadStatusEl.style.color="red";uploadBtn.disabled=!1}}
    async function finalizeOrder(){const codeInput=document.getElementById("verification-code").value.trim().toUpperCase(),finalizeBtn=document.getElementById("finalize-order-btn"),verificationStatusEl=document.getElementById("verification-status");let pendingOrder=JSON.parse(sessionStorage.getItem("pendingOrder"));if(!codeInput)return verificationStatusEl.textContent="Please enter the verification code.",verificationStatusEl.style.color="red";if(!pendingOrder)return verificationStatusEl.textContent="Error: No pending order found.",verificationStatusEl.style.color="red";finalizeBtn.disabled=!0,verificationStatusEl.textContent="Verifying...",verificationStatusEl.style.color="blue";try{const payload={action:"finalizeOrder",usedCode:codeInput,...pendingOrder},response=await fetch(googleScriptURL,{method:"POST",body:JSON.stringify(payload)}),result=await response.json();if("success"===result.status){verificationStatusEl.textContent="Order Verified! Your receipt is downloading...";verificationStatusEl.style.color="green";const downloadLink=document.createElement("a");downloadLink.href=result.receiptUrl.replace("/file/d/","/uc?export=download&id=").replace("/view?usp=drivesdk","");downloadLink.download=`Receipt-Order-${(new Date).getTime()}.pdf`;document.body.appendChild(downloadLink);downloadLink.click();document.body.removeChild(downloadLink);cart=[];sessionStorage.removeItem("pendingOrder");updateCartCount();appliedDiscount=null;document.getElementById('discount-code-input').value="";document.getElementById('discount-status').textContent="";setTimeout(()=>{toggleCart(!0);updateVerificationUI(!0)},4e3)}else throw new Error(result.message)}catch(error){verificationStatusEl.textContent=`Error: ${error.message}`;verificationStatusEl.style.color="red";finalizeBtn.disabled=!1}}
    function updateVerificationUI(reset=!1){const proofStepEl=document.getElementById("proof-upload-step"),codeStepEl=document.getElementById("code-verification-step"),uploadBtn=document.getElementById("upload-proof-btn"),finalizeBtn=document.getElementById("finalize-order-btn"),codeInput=document.getElementById("verification-code"),uploadStatusEl=document.getElementById("upload-status"),verificationStatusEl=document.getElementById("verification-status");if(reset){proofStepEl.classList.add("active");proofStepEl.classList.remove("completed");codeStepEl.classList.remove("active");uploadBtn.disabled=!1;finalizeBtn.disabled=!0;codeInput.disabled=!0;uploadStatusEl.textContent="";verificationStatusEl.textContent="";document.getElementById("payment-proof-upload").value="";codeInput.value="";return}const pendingOrder=JSON.parse(sessionStorage.getItem("pendingOrder"));if(pendingOrder){if(pendingOrder.proofUploaded){proofStepEl.classList.remove("active");proofStepEl.classList.add("completed");codeStepEl.classList.add("active");uploadBtn.disabled=!0;finalizeBtn.disabled=!1;codeInput.disabled=!1;uploadStatusEl.textContent="Proof Uploaded Successfully!";uploadStatusEl.style.color="green"}else{proofStepEl.classList.add("active");proofStepEl.classList.remove("completed");codeStepEl.classList.remove("active");uploadBtn.disabled=!1;finalizeBtn.disabled=!0;codeInput.disabled=!0}}}
    function cancelVerification(){if(confirm("Are you sure you want to cancel? This will remove your pending order and you will have to start over.")){sessionStorage.removeItem("pendingOrder");toggleCart(!0);updateVerificationUI(!0)}}
    function toggleCart(forceClose=!1){const modal=document.getElementById("cart-modal");if(forceClose){modal.style.display="none";return}if(modal.style.display==="flex"){modal.style.display="none"}else{modal.style.display="flex";if(sessionStorage.getItem("pendingOrder")){document.getElementById("cart-view").style.display="none";document.getElementById("verification-view").style.display="block";updateVerificationUI()}else{document.getElementById("cart-view").style.display="block";document.getElementById("verification-view").style.display="none";updateCartDisplay();updateVerificationUI(!0)}}}
    function getBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader;reader.readAsDataURL(file);reader.onload=()=>resolve(reader.result);reader.onerror=error=>reject(error)})}
    function filterProducts(){const input=document.getElementById("product-search").value.toLowerCase();document.querySelectorAll(".product").forEach(card=>{const name=card.dataset.productName.toLowerCase();card.style.display=name.includes(input)?"flex":"none"})}
    function suggestProduct(){console.log("AI Suggester function to be implemented.")}
</script>
</body>
</html>
