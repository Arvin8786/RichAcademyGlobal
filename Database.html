<!DOCTYPE html>
<html>
<head>
  <title>Manual Order Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4f46e5; --primary-hover: #4338ca; --secondary-color: #f3f4f6;
      --border-color: #d1d5db; --text-color: #374151; --light-text: #6b7280;
      --success-color: #10b981; --error-color: #ef4444;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; font-size: 14px; }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1, h2 { color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-top: 0; }
    h1 { font-size: 24px; } h2 { font-size: 18px; margin-top: 25px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-full { grid-column: 1 / -1; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 500; margin-bottom: 5px; }
    input, select { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
    input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
    .btn { padding: 10px 15px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-secondary { background-color: var(--light-text); color: #fff; }
    .btn-small { padding: 5px 10px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--secondary-color); font-weight: 600; }
    td input { text-align: right; }
    .summary-table td:nth-child(2) { text-align: right; font-weight: 500; }
    #customer-details { background-color: #eef2ff; padding: 15px; border-radius: 4px; border: 1px solid #c7d2fe; display: none; margin-top: 10px; }
    #loader { display: block; text-align: center; padding: 50px; }
    #success-message, #error-message { display: none; padding: 15px; border-radius: 4px; text-align: center; font-weight: 500; margin-top: 20px; }
    #success-message { background-color: #d1fae5; color: #065f46; }
    #error-message { background-color: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loader">
      <h2>Loading Portal Data...</h2>
    </div>

    <div id="main-content" style="display:none;">
      <h1>Manual Order & Database Portal</h1>
      <h2>1. Customer Details</h2>
      <div class="form-group">
        <label for="customer-search">Search for Customer by PAC</label>
        <input type="search" id="customer-search" list="customer-list" placeholder="Type PAC to search...">
        <datalist id="customer-list"></datalist>
      </div>
      <div id="customer-details"></div>

      <h2>2. Build Order</h2>
      <div class="form-group">
        <label for="product-search">Search for Products</label>
        <input type="search" id="product-search" placeholder="Type product name or SKU to filter list...">
      </div>
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
        <table id="product-table">
          <thead>
            <tr>
              <th>Product Name</th><th>SKU</th><th style="text-align:right;">Price (RM)</th><th style="width: 80px; text-align:center;">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h2>3. Order Summary</h2>
      <div class="grid">
        <div class="grid-full">
          <table id="cart-table">
            <thead>
              <tr>
                <th>Product</th><th style="width: 100px; text-align:right;">Qty</th><th style="width: 120px; text-align:right;">Unit Price (RM)</th><th style="width: 120px; text-align:right;">Total (RM)</th><th style="width: 60px; text-align:center;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div></div>
        <div>
          <table class="summary-table">
            <tr><td>Subtotal</td><td id="subtotal">0.00</td></tr>
            <tr>
              <td>Discount</td>
              <td style="display:flex; gap: 5px; align-items: center;">
                <select id="discount-type" style="width: 100px;"><option value="None">None</option><option value="Fixed">Fixed RM</option><option value="Percentage">Percentage %</option></select>
                <input type="number" id="discount-value" value="0" style="width: 80px;">
              </td>
            </tr>
            <tr><td>Shipping Fee</td><td><input type="number" id="shipping-fee" value="0.00"></td></tr>
            <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid var(--text-color);"><td>Grand Total</td><td id="grand-total">0.00</td></tr>
          </table>
        </div>
      </div>
      
      <div style="text-align: right; margin-top: 25px;">
        <button id="submit-order" class="btn btn-primary" style="font-size: 16px;">SUBMIT MANUAL ORDER</button>
      </div>
      <div id="success-message"></div>
      <div id="error-message"></div>
    </div>
  </div>

  <script>
    // --- ACTION REQUIRED: PASTE YOUR DEPLOYMENT URL HERE ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0siI7MQQ4nYgCGVOR5vUyJXQ_hVvp02uOuFVhRirBBkj_216RJxek-SCNXpsE5YHD/exec";

    let allProducts = [];
    let allCustomers = {};
    let cart = {};

    document.addEventListener('DOMContentLoaded', () => {
        fetch(SCRIPT_URL + '?action=getPortalData')
            .then(response => response.json())
            .then(onDataLoaded)
            .catch(onFailure);
    });

    function onDataLoaded(data) {
        if (data.status === 'success') {
            allProducts = data.products;
            allCustomers = data.customers;
            populateProductTable(allProducts);
            populateCustomerDatalist(allCustomers);
            document.getElementById('loader').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            setupEventListeners();
        } else { onFailure(data); }
    }

    function onFailure(error) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = 'A critical error occurred: ' + (error.message || 'Could not connect to the server.');
        errorDiv.style.display = 'block';
        document.getElementById('loader').style.display = 'none';
    }
    
    function submitOrder() {
        // ... function content ...
        const payload = { /* ... */ }; // The data to send
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Important for Apps Script POST requests from external sites
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'processManualOrder', payload: payload }),
            redirect: 'follow'
        })
        .then(response => response.json())
        .then(onOrderSuccess)
        .catch(onFailure);
    }
    
    function onOrderSuccess(response) {
       if (response.status === 'success') {
            const successDiv = document.getElementById('success-message');
            successDiv.innerHTML = `Success! Order ${response.invoiceID} created. <a href="${response.receiptUrl}" target="_blank">View Receipt</a>`;
            successDiv.style.display = 'block';
            // Reset the form
            cart = {};
            document.getElementById('customer-search').value = '';
            document.getElementById('customer-details').style.display = 'none';
            document.getElementById('discount-type').value = 'None';
            document.getElementById('discount-value').value = '0';
            document.getElementById('shipping-fee').value = '0.00';
            renderCart();
            const button = document.getElementById('submit-order');
            button.disabled = false;
            button.textContent = 'SUBMIT MANUAL ORDER';
            setTimeout(() => { successDiv.style.display = 'none'; }, 15000);
       } else { onFailure(response); }
    }
    
    // --- Helper functions (no changes needed below this line) ---
    function populateProductTable(products){const t=document.getElementById("product-table").querySelector("tbody");t.innerHTML=products.map(p=>`<tr data-sku="${p.sku}"><td>${p.name}</td><td>${p.sku}</td><td style="text-align:right;">${p.price.toFixed(2)}</td><td style="text-align:center;"><button class="btn btn-primary btn-small" onclick="addToCart(${p.sku})">Add</button></td></tr>`).join("")}
    function populateCustomerDatalist(customers){const t=document.getElementById("customer-list");t.innerHTML=Object.values(customers).map(c=>`<option value="${c.pac}">${c.name} - ${c.email}</option>`).join("")}
    function setupEventListeners(){document.getElementById("product-search").addEventListener("input",filterProducts);document.getElementById("customer-search").addEventListener("input",selectCustomer);document.getElementById("discount-type").addEventListener("change",updateSummary);document.getElementById("discount-value").addEventListener("input",updateSummary);document.getElementById("shipping-fee").addEventListener("input",updateSummary);document.getElementById("submit-order").addEventListener("click",submitOrder)}
    function filterProducts(e){const t=e.target.value.toLowerCase();const o=allProducts.filter(p=>p.name.toLowerCase().includes(t)||p.sku.toString().includes(t));populateProductTable(o)}
    function selectCustomer(e){const t=e.target.value;const o=allCustomers[t];const n=document.getElementById("customer-details");o?(n.innerHTML=`<strong>${o.name}</strong> (${o.email})<br>${o.address}`,n.style.display="block"):(n.style.display="none")}
    function addToCart(e){if(cart[e]){cart[e].quantity++}else{const t=allProducts.find(p=>p.sku===e);cart[e]={sku:t.sku,name:t.name,standardPrice:t.price,overridePrice:t.price,quantity:1}}renderCart()}
    function renderCart(){const e=document.getElementById("cart-table").querySelector("tbody");0===Object.keys(cart).length?e.innerHTML='<tr><td colspan="5" style="text-align:center; color: var(--light-text);">Cart is empty</td></tr>':e.innerHTML=Object.values(cart).map(t=>`<tr><td>${t.name}</td><td><input type="number" value="${t.quantity}" min="1" oninput="updateCartItem(${t.sku}, 'quantity', this.value)"></td><td><input type="number" value="${t.overridePrice.toFixed(2)}" step="0.01" oninput="updateCartItem(${t.sku}, 'overridePrice', this.value)"></td><td style="text-align:right;">${(t.quantity*t.overridePrice).toFixed(2)}</td><td style="text-align:center;"><button class="btn btn-secondary btn-small" onclick="removeFromCart(${t.sku})">X</button></td></tr>`).join("");updateSummary()}
    function updateCartItem(e,t,o){cart[e]&&(cart[e][t]=parseFloat(o)||0,renderCart())}
    function removeFromCart(e){delete cart[e];renderCart()}
    function updateSummary(){let e=0;Object.values(cart).forEach(t=>{e+=t.quantity*t.overridePrice});document.getElementById("subtotal").textContent=e.toFixed(2);const t=document.getElementById("discount-type").value;const o=parseFloat(document.getElementById("discount-value").value)||0;let n=0;"Percentage"===t&&o>0?n=e*(o/100):"Fixed"===t&&(n=o);const c=parseFloat(document.getElementById("shipping-fee").value)||0;const d=e-n+c;document.getElementById("grand-total").textContent=d.toFixed(2)}
  </script>
</body>
</html>
