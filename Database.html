<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4f46e5; --primary-hover: #4338ca; --secondary-color: #f3f4f6;
      --border-color: #d1d5db; --text-color: #374151; --light-text: #6b7280;
      --success-color: #10b981; --error-color: #ef4444;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; font-size: 14px; }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1, h2 { color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-top: 0; }
    h1 { font-size: 24px; } h2 { font-size: 18px; margin-top: 25px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-full { grid-column: 1 / -1; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 500; margin-bottom: 5px; }
    input, select { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
    input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
    input[type="search"]::-webkit-search-cancel-button { display: none; }
    .btn { padding: 10px 15px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-secondary { background-color: var(--light-text); color: #fff; }
    .btn-small { padding: 5px 10px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--secondary-color); font-weight: 600; }
    td input { text-align: right; }
    .summary-table td:nth-child(2) { text-align: right; font-weight: 500; }
    #customer-details { background-color: #eef2ff; padding: 15px; border-radius: 4px; border: 1px solid #c7d2fe; display: none; margin-top: 10px; }
    #loader { display: none; text-align: center; padding: 50px; }
    #success-message { display: none; background-color: #d1fae5; color: #065f46; padding: 15px; border-radius: 4px; text-align: center; font-weight: 500; margin-top: 20px; }
  </style>
</head>
<body>
  <div id="loader">
    <h2>Loading Portal Data...</h2>
  </div>

  <div id="main-content" style="display:none;">
    <div class="container">
      <h1>Manual Order & Database Portal</h1>

      <!-- Customer Section -->
      <h2>1. Customer Details</h2>
      <div class="form-group">
        <label for="customer-search">Search for Customer by PAC</label>
        <input type="search" id="customer-search" list="customer-list" placeholder="Type PAC to search...">
        <datalist id="customer-list"></datalist>
      </div>
      <div id="customer-details"></div>

      <!-- Product Section -->
      <h2>2. Build Order</h2>
      <div class="form-group">
        <label for="product-search">Search for Products</label>
        <input type="search" id="product-search" placeholder="Type product name or SKU to filter list...">
      </div>
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
        <table id="product-table">
          <thead>
            <tr>
              <th>Product Name</th>
              <th>SKU</th>
              <th style="text-align:right;">Price (RM)</th>
              <th style="width: 80px; text-align:center;">Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Product rows will be injected here by JavaScript -->
          </tbody>
        </table>
      </div>

      <!-- Cart Section -->
      <h2>3. Order Summary</h2>
      <div class="grid">
        <div class="grid-full">
          <table id="cart-table">
            <thead>
              <tr>
                <th>Product</th>
                <th style="width: 100px; text-align:right;">Qty</th>
                <th style="width: 120px; text-align:right;">Unit Price (RM)</th>
                <th style="width: 120px; text-align:right;">Total (RM)</th>
                <th style="width: 60px; text-align:center;"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Cart items will be injected here -->
            </tbody>
          </table>
        </div>
        
        <div>
           <!-- This space can be used for notes in the future -->
        </div>

        <div>
          <table class="summary-table">
            <tr><td>Subtotal</td><td id="subtotal">0.00</td></tr>
            <tr>
              <td>Discount</td>
              <td style="display:flex; gap: 5px; align-items: center;">
                <select id="discount-type" style="width: 100px;">
                  <option value="None">None</option>
                  <option value="Fixed">Fixed RM</option>
                  <option value="Percentage">Percentage %</option>
                </select>
                <input type="number" id="discount-value" value="0" style="width: 80px;">
              </td>
            </tr>
            <tr><td>Shipping Fee</td><td><input type="number" id="shipping-fee" value="0.00"></td></tr>
            <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid var(--text-color);">
                <td>Grand Total</td>
                <td id="grand-total">0.00</td>
            </tr>
          </table>
        </div>
      </div>
      
      <div style="text-align: right; margin-top: 25px;">
        <button id="submit-order" class="btn btn-primary" style="font-size: 16px;">SUBMIT MANUAL ORDER</button>
      </div>
      <div id="success-message"></div>
    </div>
  </div>

  <script>
    let allProducts = [];
    let allCustomers = {}; // Use an object for quick PAC lookups
    let cart = {};

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loader').style.display = 'block';
      // This is the call from the HTML page to the Code.gs file
      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(onFailure)
        .getPortalData();
    });

    function onDataLoaded(data) {
      if (data.status === 'success') {
          allProducts = data.products;
          allCustomers = data.customers;
          populateProductTable(allProducts);
          populateCustomerDatalist(allCustomers);
          document.getElementById('loader').style.display = 'none';
          document.getElementById('main-content').style.display = 'block';
          setupEventListeners();
      } else {
          onFailure(data);
      }
    }

    function onFailure(error) {
      alert('Failed to load portal data: ' + error.message);
    }
    
    function populateProductTable(products) {
      const tbody = document.getElementById('product-table').querySelector('tbody');
      tbody.innerHTML = products.map(p => `
        <tr data-sku="${p.sku}">
          <td>${p.name}</td>
          <td>${p.sku}</td>
          <td style="text-align:right;">${p.price.toFixed(2)}</td>
          <td style="text-align:center;">
            <button class="btn btn-primary btn-small" onclick="addToCart(${p.sku})">Add</button>
          </td>
        </tr>
      `).join('');
    }

    function populateCustomerDatalist(customers) {
      const datalist = document.getElementById('customer-list');
      datalist.innerHTML = Object.values(customers).map(c => `<option value="${c.pac}">${c.name} - ${c.email}</option>`).join('');
    }
    
    // --- EVENT LISTENERS ---
    function setupEventListeners() {
      document.getElementById('product-search').addEventListener('input', filterProducts);
      document.getElementById('customer-search').addEventListener('input', selectCustomer);
      document.getElementById('discount-type').addEventListener('change', updateSummary);
      document.getElementById('discount-value').addEventListener('input', updateSummary);
      document.getElementById('shipping-fee').addEventListener('input', updateSummary);
      document.getElementById('submit-order').addEventListener('click', submitOrder);
    }

    // --- CORE FUNCTIONS ---
    function filterProducts(e) {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm) || 
        p.sku.toString().includes(searchTerm)
      );
      populateProductTable(filtered);
    }
    
    function selectCustomer(e) {
      const pac = e.target.value;
      const customer = allCustomers[pac];
      const detailsDiv = document.getElementById('customer-details');
      if (customer) {
        detailsDiv.innerHTML = `<strong>${customer.name}</strong> (${customer.email})<br>${customer.address}`;
        detailsDiv.style.display = 'block';
      } else {
        detailsDiv.style.display = 'none';
      }
    }

    function addToCart(sku) {
      if (cart[sku]) {
        cart[sku].quantity++;
      } else {
        const product = allProducts.find(p => p.sku === sku);
        cart[sku] = {
          sku: product.sku,
          name: product.name,
          standardPrice: product.price,
          overridePrice: product.price,
          quantity: 1
        };
      }
      renderCart();
    }
    
    function renderCart() {
      const tbody = document.getElementById('cart-table').querySelector('tbody');
      if (Object.keys(cart).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--light-text);">Cart is empty</td></tr>';
      } else {
        tbody.innerHTML = Object.values(cart).map(item => `
          <tr>
            <td>${item.name}</td>
            <td><input type="number" value="${item.quantity}" min="1" oninput="updateCartItem(${item.sku}, 'quantity', this.value)"></td>
            <td><input type="number" value="${item.overridePrice.toFixed(2)}" step="0.01" oninput="updateCartItem(${item.sku}, 'overridePrice', this.value)"></td>
            <td style="text-align:right;">${(item.quantity * item.overridePrice).toFixed(2)}</td>
            <td style="text-align:center;"><button class="btn btn-secondary btn-small" onclick="removeFromCart(${item.sku})">X</button></td>
          </tr>
        `).join('');
      }
      updateSummary();
    }
    
    function updateCartItem(sku, key, value) {
      if (cart[sku]) {
        cart[sku][key] = parseFloat(value) || 0;
        renderCart();
      }
    }

    function removeFromCart(sku) {
      delete cart[sku];
      renderCart();
    }
    
    function updateSummary() {
      let subtotal = 0;
      Object.values(cart).forEach(item => {
        subtotal += item.quantity * item.overridePrice;
      });
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);

      const discountType = document.getElementById('discount-type').value;
      const discountValue = parseFloat(document.getElementById('discount-value').value) || 0;
      let totalDiscount = 0;
      if (discountType === 'Percentage' && discountValue > 0) {
        totalDiscount = subtotal * (discountValue / 100);
      } else if (discountType === 'Fixed') {
        totalDiscount = discountValue;
      }
      
      const shipping = parseFloat(document.getElementById('shipping-fee').value) || 0;
      const grandTotal = subtotal - totalDiscount + shipping;
      document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }
    
    function submitOrder() {
      const customerPAC = document.getElementById('customer-search').value;
      if (!allCustomers[customerPAC]) {
        alert('Please select a valid customer.');
        return;
      }
      if (Object.keys(cart).length === 0) {
        alert('Cannot submit an empty order. Please add products to the cart.');
        return;
      }
      
      const button = document.getElementById('submit-order');
      button.disabled = true;
      button.textContent = 'Processing...';

      const payload = {
        customer: allCustomers[customerPAC],
        cart: Object.values(cart),
        discountType: document.getElementById('discount-type').value,
        discountValue: parseFloat(document.getElementById('discount-value').value) || 0,
        shippingFee: parseFloat(document.getElementById('shipping-fee').value) || 0,
        grandTotal: parseFloat(document.getElementById('grand-total').textContent) || 0,
      };

      google.script.run
        .withSuccessHandler(onOrderSuccess)
        .withFailureHandler(onFailure)
        .processManualOrder(payload);
    }
    
    function onOrderSuccess(response) {
       if (response.status === 'success') {
            const successDiv = document.getElementById('success-message');
            successDiv.innerHTML = `Success! Order ${response.invoiceID} created. <a href="${response.receiptUrl}" target="_blank">View Receipt</a>`;
            successDiv.style.display = 'block';

            // Reset the form
            cart = {};
            document.getElementById('customer-search').value = '';
            document.getElementById('customer-details').style.display = 'none';
            document.getElementById('discount-type').value = 'None';
            document.getElementById('discount-value').value = '0';
            document.getElementById('shipping-fee').value = '0.00';
            renderCart();
            
            const button = document.getElementById('submit-order');
            button.disabled = false;
            button.textContent = 'SUBMIT MANUAL ORDER';

            setTimeout(() => { successDiv.style.display = 'none'; }, 15000);
       } else {
           onFailure(response);
       }
    }

  </script>
</body>
</html>
