// --- CONFIGURATION ---
const SPREADSHEET_ID = '19huSirUr186LPCLsS-k2ElrvWsJN580uyprHFh2Zb9g';

// --- GLOBAL CONSTANTS ---
const SHEET_PRODUCTS = 'Product_Master';
const SHEET_ORDER_LOG = 'Order_Log';
const SHEET_CUSTOMERS = 'Customers';
const SHEET_ITEMIZED_SALES = 'Itemized_Sales';
const FINAL_RECEIPT_FOLDER_ID = '1LQnItk07gntSOEv4qQUjfrik3fdxuanx';
const LOGO_URL = 'https://i.imgur.com/E4ZAT1K.png';

// =================================================================
// WEB APP & PORTAL FUNCTIONS
// =================================================================

/**
 * This doGet function is not used by the external portal, but is required by Apps Script.
 * It can be used for testing or as a placeholder.
 */
function doGet(e) {
  return HtmlService.createHtmlOutput("Manual Order Portal Backend is running.");
}

/**
 * [FINAL CORRECTED VERSION] This doPost handles all requests from the external portal.
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    let responsePayload;

    if (data.action === 'getPortalData') {
        responsePayload = getPortalData();
    } else if (data.action === 'processManualOrder') { 
        responsePayload = processManualOrder(data.payload);
    } else {
        throw new Error("Unknown action received: " + data.action);
    }
    
    // Add CORS header to all successful responses
    return ContentService.createTextOutput(JSON.stringify(responsePayload))
      .setMimeType(ContentService.MimeType.JSON)
      .withHeaders({"Access-Control-Allow-Origin": "*"});

  } catch (error) { 
    const errorPayload = { status: 'error', message: error.message, stack: error.stack };
    // Add CORS header to the error response as well
    return ContentService.createTextOutput(JSON.stringify(errorPayload))
      .setMimeType(ContentService.MimeType.JSON)
      .withHeaders({"Access-Control-Allow-Origin": "*"});
  }
}

/**
 * Bundles all necessary data for the admin portal into one call.
 */
function getPortalData() {
    try {
        const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
        const products = getProductsData(spreadsheet);
        const customers = getCustomersData(spreadsheet);
        return { status: 'success', products: products, customers: customers };
    } catch (error) {
        return { status: 'error', message: error.message, stack: error.stack };
    }
}

/**
 * This function is called by the portal to process a manual order.
 */
function processManualOrder(payload) {
    try {
        const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
        const orderLogSheet = spreadsheet.getSheetByName(SHEET_ORDER_LOG);
        const indexes = getColumnIndexes(orderLogSheet);
        const nextRow = orderLogSheet.getLastRow() + 1;
        const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd");
        const invoiceID = `INV-${today}-M${nextRow}`;

        const customer = payload.customer;
        const cart = payload.cart;

        const itemsPurchased = cart.map(item => `${item.quantity} x ${item.name}`).join(', ');
        const discountApplied = payload.discountType !== 'None' ? `${payload.discountType} - ${payload.discountValue}` : 'N/A';
        
        const logData = [];
        logData[indexes['Timestamp'] - 1] = new Date();
        logData[indexes['CustomerName'] - 1] = customer.name;
        logData[indexes['CustomerEmail'] - 1] = customer.email;
        logData[indexes['CustomerPhone'] - 1] = customer.phone;
        logData[indexes['CustomerAddress'] - 1] = customer.address;
        logData[indexes['ItemsPurchased'] - 1] = itemsPurchased;
        logData[indexes['DiscountApplied'] - 1] = discountApplied;
        logData[indexes['TotalAmount'] - 1] = payload.grandTotal;
        logData[indexes['ShippingFee'] - 1] = payload.shippingFee;
        logData[indexes['PointsEarned'] - 1] = 0;
        logData[indexes['Status'] - 1] = "Approved";
        logData[indexes['PaymentProofLink'] - 1] = "Manual Order";
        logData[indexes['InvoiceID'] - 1] = invoiceID;
        logData[indexes['Cart_Data'] - 1] = JSON.stringify(cart);
        logData[indexes['Sales_Logged'] - 1] = true;
        logData[indexes['PAC'] - 1] = customer.pac;
        
        const fullRow = [];
        for(let i=0; i < orderLogSheet.getLastColumn(); i++) {
            fullRow[i] = logData[i] || "";
        }
        orderLogSheet.appendRow(fullRow);

        logItemizedSales(spreadsheet, invoiceID, new Date(), customer.pac, cart, payload.shippingFee);

        const receiptData = {
            cart: cart.map(item => ({...item, finalPrice: item.overridePrice, id: item.sku})),
            discountApplied: discountApplied, totalAmount: payload.grandTotal, shippingFee: payload.shippingFee,
            customerName: customer.name, customerEmail: customer.email, customerPhone: customer.phone, customerAddress: customer.address,
            appliedPromotions: []
        };

        const receiptUrl = createReceiptPdf(invoiceID, customer.pac, receiptData, 0, customer.points);
        orderLogSheet.getRange(nextRow, indexes['FinalReceiptURL']).setValue(receiptUrl);

        return { status: 'success', invoiceID: invoiceID, receiptUrl: receiptUrl };
    } catch (error) {
        return { status: 'error', message: error.message, stack: error.stack };
    }
}

// =================================================================
// HELPER FUNCTIONS 
// =================================================================

function getProductsData(spreadsheet) {
    const sheet = spreadsheet.getSheetByName(SHEET_PRODUCTS);
    return sheet.getDataRange().getValues().slice(1)
        .filter(row => row[0]) // Filter: requires a SKU in column A
        .map(row => ({ sku: parseInt(row[0]), name: row[2], price: parseFloat(row[5]) || 0 }));
}

function getCustomersData(spreadsheet) {
    const sheet = spreadsheet.getSheetByName(SHEET_CUSTOMERS);
    const data = sheet.getDataRange().getValues().slice(1);
    const customers = {};
    data.forEach(row => {
        const pac = row[0];
        if (pac) {
            customers[pac] = { pac: pac, name: row[1], email: row[2], phone: row[3], address: row[4], points: row[5] || 0 };
        }
    });
    return customers;
}

function logItemizedSales(spreadsheet, invoiceID, saleDate, customerPAC, cartItems, shippingFee) {
  const salesSheet = spreadsheet.getSheetByName(SHEET_ITEMIZED_SALES);
  const productSheet = spreadsheet.getSheetByName(SHEET_PRODUCTS);
  const productData = productSheet.getDataRange().getValues();
  const productMap = new Map(productData.map(row => [parseInt(row[0]), row]));
  const shippingCost = parseFloat(shippingFee) || 0;

  const rowsToAdd = cartItems.map((item, index) => {
    const skuToLookup = item.sku || item.id;
    const productInfo = productMap.get(skuToLookup); 
    const costPrice = productInfo ? (parseFloat(productInfo[4]) || 0) : 0;
    const itemShippingCost = (index === 0) ? shippingCost : 0;
    const quantity = parseInt(item.quantity) || 0;
    const unitPrice = parseFloat(item.overridePrice) || 0;
    const totalSale = quantity * unitPrice;
    const totalCost = quantity * costPrice;
    const profit = totalSale - totalCost - itemShippingCost;

    return [
      Utilities.getUuid(), invoiceID, saleDate, "SALE", customerPAC, skuToLookup, item.name,
      quantity, unitPrice, totalSale, costPrice, itemShippingCost, profit, "Completed"
    ];
  });
  if (rowsToAdd.length > 0) {
    salesSheet.getRange(salesSheet.getLastRow() + 1, 1, rowsToAdd.length, 14).setValues(rowsToAdd);
  }
}

function createReceiptPdf(orderID, pac, data, pointsThisPurchase, totalAccumulatedPoints) {
  const folder = DriveApp.getFolderById(FINAL_RECEIPT_FOLDER_ID);
  const logoBase64 = getImageAsBase64(LOGO_URL);
  let itemsHtml = data.cart.map(item => `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${item.id || item.sku}</td><td style="padding: 8px; border-bottom: 1px solid #eee;">${item.name}</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${item.quantity}</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">RM ${parseFloat(item.finalPrice || item.overridePrice).toFixed(2)}</td></tr>`).join('');
  const discountAppliedText = data.discountApplied || 'N/A';
  const discountValue = parseFloat(discountAppliedText.split(' - RM ')[1]) || 0;
  const nettPrice = parseFloat(data.totalAmount);
  const subtotal = nettPrice - parseFloat(data.shippingFee) + discountValue;

  const htmlContent = `
    <html>
      <body style="font-family: Arial, sans-serif; color: #333; margin: 20px;">
        ${logoBase64 ? `<img src="${logoBase64}" style="max-height: 80px; display: block; margin-bottom: 20px;">` : ''}
        <h1 style="color: #1a5276;">Official Receipt</h1>
        <table style="width: 100%; margin-bottom: 20px;">
          <tr>
            <td><strong>Invoice No:</strong> ${orderID}<br><strong>Date:</strong> ${new Date().toLocaleString('en-GB')}</td>
            <td style="text-align: right;"><strong>Customer ID:</strong> ${pac || 'N/A'}<br><strong>Status:</strong> Paid</td>
          </tr>
        </table><hr>
        <h3 style="color: #1a5276;">Customer Details:</h3>
        <p>${data.customerName}<br>${data.customerEmail}<br>${data.customerPhone}<br>${data.customerAddress}</p><hr>
        <h3 style="color: #1a5276;">Order Summary:</h3>
        <table style="width:100%; border-collapse: collapse;">
          <thead><tr><th style="border-bottom: 2px solid #333; padding: 8px; text-align: left;">SKU</th><th style="border-bottom: 2px solid #333; padding: 8px; text-align: left;">Item</th><th style="border-bottom: 2px solid #333; padding: 8px; text-align: center;">Qty</th><th style="border-bottom: 2px solid #333; padding: 8px; text-align: right;">Price</th></tr></thead>
          <tbody>${itemsHtml}</tbody>
        </table><hr>
        <table style="width: 100%; margin-top: 15px;">
          <tr><td>Subtotal:</td><td style="text-align: right;">RM ${subtotal.toFixed(2)}</td></tr>
          <tr><td>Discount Applied:</td><td style="text-align: right;">- RM ${discountValue.toFixed(2)}</td></tr>
          <tr><td>Shipping Fee:</td><td style="text-align: right;">RM ${parseFloat(data.shippingFee).toFixed(2)}</td></tr>
          <tr><td colspan="2"><hr></td></tr>
          <tr style="font-weight: bold; font-size: 1.2em;"><td>Nett Price:</td><td style="text-align: right;">RM ${nettPrice.toFixed(2)}</td></tr>
        </table>
      </body>
    </html>`;

  const blob = Utilities.newBlob(htmlContent, MimeType.HTML, `${orderID}-Receipt.html`);
  const pdfFile = folder.createFile(blob.getAs(MimeType.PDF)).setName(`${orderID}-Receipt.pdf`);
  pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  const fileId = pdfFile.getId();
  return `https://drive.google.com/uc?id=${fileId}&export=download`;
}

function getImageAsBase64(url) {
    if (!url || !url.startsWith('http')) return null;
    try {
        const response = UrlFetchApp.fetch(url);
        const blob = response.getBlob();
        return "data:" + blob.getContentType() + ";base64," + Utilities.encodeBase64(blob.getBytes());
    } catch (e) { return null; }
}

function getColumnIndexes(sheet) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const indexes = {};
  headers.forEach((header, i) => { if (header) { indexes[header.trim()] = i + 1; } });
  return indexes;
}
